<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Galeri Keyboard Navigasi & Zoom Otomatis</title>
    <style>
:root {
    --neon-blue: #00ffff; /* Biru Neon Cerah */
    --dark-background: #121212; /* Latar Belakang Sangat Gelap */
    --card-background: #1e1e1e; /* Latar Belakang Card Gelap */
    --input-background: #2a2a2a; /* Latar Belakang Input Gelap */
    --border-color: #00bfff; /* Biru Neon Sekunder untuk batas */
    --text-color: #e0f7fa; /* Teks Putih Kebiruan */
    --secondary-neon: #00bfff; /* Biru Neon Sekunder untuk highlight */
    --danger-color: #ff4d4d; /* Merah Neon untuk bahaya */
    --success-color: #39ff14; /* Hijau Neon untuk sukses */
    --warning-color: #f1c40f; /* Kuning Neon untuk peringatan/caption */
    --primary-button: #00bfff; /* Warna utama tombol */
    --primary-button-hover: #00e5ff;
}

body {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background-color: var(--dark-background);
    color: var(--text-color);
    padding: 20px;
    margin: 0;
    line-height: 1.6;
}

.container, 
.scatter-section {
    max-width: 960px;
    margin: 20px auto;
    background: var(--card-background); 
    padding: 30px;
    border-radius: 12px;
    /* Efek glow biru neon */
    box-shadow: 0 0 20px rgba(0, 255, 255, 0.2), 0 0 10px rgba(0, 255, 255, 0.1); 
    border: 1px solid var(--secondary-neon);
}

.scatter-section {
    padding: 20px;
    margin-bottom: 25px;
}

h1 {
    text-align: center;
    color: var(--neon-blue);
    margin-bottom: 25px;
    /* Efek neon */
    text-shadow: 0 0 8px var(--neon-blue), 0 0 15px var(--secondary-neon); 
    font-size: 2.5em;
}

h2 {
    text-align: center;
    color: var(--secondary-neon);
    margin-top: 20px;
    text-shadow: 0 0 5px rgba(0, 191, 255, 0.7);
}

.judul-glow {
    text-align: center;
    color: var(--success-color); /* Menggunakan warna sukses neon */
    text-shadow: 0 0 10px var(--success-color), 0 0 20px var(--success-color);
    margin-bottom: 20px;
    font-size: 2.5em; /* Konsisten dengan h1 */
}

/* * --- Form, Input & Tombol --- 
 */
textarea {
    width: 100%;
    padding: 12px;
    margin-bottom: 15px;
    border: 1px solid var(--secondary-neon); /* Border neon */
    box-sizing: border-box;
    background-color: var(--input-background); /* Latar belakang gelap */
    color: var(--text-color);
    border-radius: 6px;
    resize: vertical;
    /* Efek glow ringan saat fokus */
    transition: box-shadow 0.3s;
}

textarea:focus {
    outline: none;
    box-shadow: 0 0 8px rgba(0, 191, 255, 0.8);
}

/* Style untuk semua button yang tidak spesifik */
button,
.btn {
    padding: 10px 18px;
    color: var(--dark-background);
    background-color: var(--primary-button); /* Biru neon sebagai warna primer */
    border: none;
    border-radius: 6px;
    cursor: pointer;
    transition: background-color 0.3s, box-shadow 0.3s;
    font-weight: bold;
    margin-right: 10px;
    /* Efek neon ringan */
    box-shadow: 0 0 5px rgba(0, 191, 255, 0.5);
}

button:hover,
.btn:hover {
    background-color: var(--primary-button-hover);
    box-shadow: 0 0 10px var(--primary-button-hover);
}

/* Tombol Danger */
#clearDataBtn,
.btn.danger {
    background-color: var(--danger-color); /* Merah Neon */
    color: var(--text-color);
    box-shadow: 0 0 5px var(--danger-color);
}
#clearDataBtn:hover,
.btn.danger:hover {
    background-color: #ff8080; /* Merah yang lebih terang saat hover */
    box-shadow: 0 0 10px var(--danger-color);
}

.button-group {
    display: flex;
    justify-content: flex-end; /* Posisikan tombol Hapus di kanan */
    margin-bottom: 15px;
    margin-top: 10px; /* Diperbarui agar lebih konsisten */
    text-align: unset; /* override center dari style lama */
}

/* * --- Galeri dan Slot Gambar Utama --- 
 */
.gallery-container {
    display: flex;
    align-items: center;
    justify-content: center;
    margin-top: 20px;
}

/* ----- Tampilan Gabungan (Slot) ----- */
.combined-image-slot {
    flex-grow: 0;
    width: 80%;
    max-width: 700px;
    display: flex;
    justify-content: center;
    align-items: center;
    position: relative;
    border: 2px solid var(--secondary-neon);
    padding: 5px;
    border-radius: 8px;
    cursor: pointer;
    transition: transform 0.3s, box-shadow 0.3s, opacity 0.3s;
    background-color: var(--input-background);
    min-height: 200px;
}

.combined-image-slot:hover {
    transform: scale(1.03);
    /* Efek glow saat hover */
    box-shadow: 0 0 15px rgba(0, 191, 255, 0.8), 0 0 20px rgba(0, 191, 255, 0.4); 
}

.combined-image-slot img {
    max-width: 33.33%; 
    height: 180px; 
    object-fit: contain; 
    display: block;
    margin: 0;
    border-radius: 4px; 
}
 
.combined-image-slot .caption-userid {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    color: var(--warning-color);
    font-size: 1.5em;
    font-weight: bold;
    background-color: rgba(0,0,0,0.8); /* Background yang lebih gelap untuk kontras */
    padding: 5px 10px;
    border-radius: 5px;
    display: none; 
    pointer-events: none; 
    z-index: 10;
}
.combined-image-slot:hover .caption-userid {
    display: block;
}

.package-info {
    text-align: center;
    margin-top: 20px;
    font-weight: bold;
    font-size: 1.1em;
    color: var(--neon-blue); /* Warna neon yang konsisten */
    text-shadow: 0 0 5px var(--neon-blue);
}

/* * --- Galeri Multi Gambar (Thumbnail) ---
 */
.gambar-container-multi {
    margin-top: 12px;
    display: flex;
    gap: 12px;
    flex-wrap: wrap;
    justify-content: center; /* Dipusatkan agar rapi */
}
.gambar-slot-multi {
    text-align: center;
    width: 110px;
    transition: transform 0.2s;
}
.gambar-slot-multi:hover {
    transform: translateY(-3px);
}
.gambar-slot-multi img {
    max-width: 100%;
    height: auto; /* Agar tidak terpotong */
    border-radius: 4px;
    cursor: pointer;
    border: 1px solid var(--secondary-neon);
    box-shadow: 0 0 5px rgba(0, 191, 255, 0.3);
    transition: border 0.3s, box-shadow 0.3s;
}
.gambar-slot-multi img:hover {
    border: 1px solid var(--neon-blue);
    box-shadow: 0 0 10px var(--neon-blue);
}
.userid-label {
    margin-top: 6px;
    font-size: 12px;
    color: var(--warning-color); /* Kuning neon */
}

.modal,
.lightbox-modal {
    display: none;
    position: fixed; 
    z-index: 9999;
    left: 0;
    top: 0;
    width: 100%; 
    height: 100%; 
    overflow: auto; 
    background-color: rgba(0,0,0,0.95);
    justify-content: center;
    align-items: center;
    flex-direction: column;
    padding: 20px;
}

.zoomed-content-area {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 100%;
}

.zoom-nav-button,
.nav-btn {
    background-color: transparent;
    color: var(--secondary-neon);
    border: none;
    font-size: 3em;
    padding: 0 20px;
    cursor: pointer;
    transition: color 0.3s, background-color 0.3s;
    z-index: 10000;
    user-select: none;
}

.zoom-nav-button:hover:not(:disabled),
.nav-btn:hover {
    color: var(--neon-blue);
    background: rgba(0, 191, 255, 0.1); /* Efek hover ringan */
}
/* Nav button spesifik untuk lightbox */
.nav-btn {
    position: absolute;
    top: 20%;
    transform: translateY(-50%);
    font-size: 40px;
    padding: 10px 15px;
    border-radius: 20%;
    background: rgba(0,0,0,0.5);
}
.prev { left: 20px; }
.next { right: 20px; }

.zoomed-content-wrapper {
    display: flex; 
    justify-content: center;
    align-items: center;
    gap: 10px; /* Jarak yang lebih besar agar jelas */
    width: 90%;
    max-width: 1200px; 
    max-height: 80vh;
    margin: 10px 0;
    overflow: hidden; 
}

.zoomed-content-wrapper img,
.lightbox-modal img {
    max-width: calc(33.33% - 10px); /* Disesuaikan dengan gap */
    height: auto;
    max-height: 80vh;
    border-radius: 8px;
    /* Efek glow yang lebih menonjol untuk gambar utama */
    box-shadow: 0 0 15px rgba(0, 191, 255, 0.8), 0 0 25px rgba(0, 191, 255, 0.5); 
    object-fit: contain;
    min-width: 0;
}
.lightbox-modal img {
    max-width: 90%;
    box-shadow: 0 0 20px rgba(255,255,255,0.5), 0 0 30px var(--neon-blue);
}

.zoomed-userid {
    display: block;
    text-align: center;
    color: var(--warning-color);
    font-size: 2.2em;
    font-weight: bold;
    margin-bottom: 15px;
    text-shadow: 0 0 10px var(--warning-color);
}
 
.zoom-link-input-area { display: none; } /* Tetap disembunyikan */

.close-btn,
.close {
    position: absolute;
    top: 20px;
    right: 35px;
    color: var(--danger-color);
    font-size: 45px;
    font-weight: bold;
    transition: 0.3s;
    cursor: pointer;
    text-shadow: 0 0 10px var(--danger-color);
    z-index: 10000;
}

.close-btn:hover,
.close-btn:focus,
.close:hover {
    color: #ff8080; /* Merah terang saat hover */
    text-decoration: none;
}

.lightbox-caption {
    margin-top: 10px;
    color: var(--text-color);
    font-size: 14px;
    background: rgba(0,0,0,0.7);
    padding: 8px 12px;
    border-radius: 4px;
    text-shadow: 0 0 5px var(--warning-color);
}

.scatter-controls { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .input-group, .controls-group { margin-bottom: 15px; padding: 10px; border: 1px solid #444; border-radius: 8px; background: #3a3a3a; }
        .input-group label { display: block; margin-bottom: 5px; color: #ccc; }
        .column-input-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin-bottom: 20px; }
        .column-input { background: #444; border-radius: 8px; padding: 15px; border: 1px solid #555; transition: all 0.3s; }
        .column-input.minimized textarea { height: 0; padding: 0 10px; opacity: 0; transition: all 0.3s; }
        .column-input h3 { display: flex; justify-content: space-between; align-items: center; margin-top: 0; color: #00ffff; font-size: 16px; }
        .column-input textarea { width: 100%; height: 100px; padding: 10px; border: 1px solid #666; background: #2c2c2c; color: #fff; resize: vertical; border-radius: 4px; }
        .clear-col-btn { background: #f00; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer; transition: background 0.3s; }
        .clear-col-btn:hover { background: #c00; }
        .indicator { width: 10px; height: 10px; border-radius: 50%; background-color: #555; margin-left: 10px; display: inline-block; }

        /* Hasil Scatter */
        .scatter-results { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin-top: 20px; }
        .result-block { background: #2c2c2c; padding: 15px; border-radius: 8px; border: 1px solid #555; }
        .result-block h4 { color: #00ffff; margin-top: 0; border-bottom: 1px dotted #444; padding-bottom: 5px; }
        .result-item { display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px; font-size: 14px; }
        .result-item label { color: #aaa; flex-basis: 35%; }
        .result-item .data-text { flex-basis: 60%; font-weight: bold; overflow-wrap: break-word; }
        .copy-btn { background: #007bff; color: white; border: none; padding: 3px 8px; margin-left: 5px; border-radius: 4px; cursor: pointer; transition: background 0.3s; }
        .copy-btn:hover { background: #0056b3; }
        .link-group, .action-group { margin-top: 10px; display: flex; gap: 8px; flex-wrap: wrap; }
        .view-image-btn, .cancel-btn, .undo-btn { padding: 6px 10px; border-radius: 4px; cursor: pointer; font-size: 12px; border: none; transition: opacity 0.3s; }
        .view-image-btn { background: #28a745; color: white; }
        .view-image-btn.no-link { opacity: 0.5; cursor: default; background: #6c757d; }
        .cancel-btn { background: #dc3545; color: white; }
        .undo-btn { background: #ffc107; color: #212529; }

        /* Modal Zoom */
        #imageModal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.95); }
        .modal-content { position: relative; margin: auto; padding: 20px; width: 80%; max-width: 1200px; background: #1a1a1a; border-radius: 10px; top: 50%; transform: translateY(-50%); }
        .close-btn { color: #fff; font-size: 40px; font-weight: bold; position: absolute; top: 10px; right: 25px; cursor: pointer; transition: color 0.3s; }
        .close-btn:hover { color: #00ffff; }
        #imagesContainer { display: flex; flex-direction: column; align-items: center; gap: 15px; max-height: 70vh; overflow-y: auto; padding: 10px; border: 1px solid #333; border-radius: 8px; transition: transform 0.3s ease-out; }
        #imagesContainer img { max-width: 100%; height: auto; border-radius: 6px; box-shadow: 0 0 10px rgba(0, 0, 0, 0.5); }
        .modal-info { color: #aaa; margin-bottom: 15px; border-bottom: 1px solid #444; padding-bottom: 10px; }

        /* Modal Controls & Nav */
        .modal-controls { display: flex; justify-content: space-between; align-items: center; margin-top: 15px; }
        #modalNavigation { display: flex; gap: 5px; }
        .nav-btn { padding: 8px 12px; background: #555; color: white; border: none; border-radius: 5px; cursor: pointer; transition: background 0.3s; }
        .nav-btn:hover { background: #777; }
        .nav-btn.active-col { background: #00ffff; color: #111; font-weight: bold; }
        .zoom-controls button { background: #555; color: white; border: none; padding: 8px 12px; border-radius: 5px; cursor: pointer; margin-left: 5px; }
        #zoomIndicator { margin-left: 10px; font-weight: bold; color: #00ffff; }
        
        /* Credit Calculator */
        #creditCalculatorTab textarea { width: 100%; height: 200px; background: #2c2c2c; color: #fff; border: 1px solid #666; padding: 10px; margin-bottom: 15px; border-radius: 4px; resize: vertical; }
        .credit-result-box { background: #444; padding: 15px; border-radius: 8px; display: flex; justify-content: space-between; align-items: center; font-size: 18px; font-weight: bold; color: #fff; }
        #creditTotal { color: #ffc107; font-size: 24px; }
        
        /* Toast Notification */
        #toast { visibility: hidden; min-width: 250px; background-color: #333; color: #fff; text-align: center; border-radius: 2px; padding: 10px; position: fixed; z-index: 1001; left: 50%; bottom: 30px; transform: translateX(-50%); box-shadow: 0 0 10px rgba(0, 0, 0, 0.5); }
        #toast.show { visibility: visible; -webkit-animation: fadein 0.5s, fadeout 0.5s 2s; animation: fadein 0.5s, fadeout 0.5s 2s; }

        @-webkit-keyframes fadein { from {bottom: 0; opacity: 0;} to {bottom: 30px; opacity: 1;} }
        @keyframes fadein { from {bottom: 0; opacity: 0;} to {bottom: 30px; opacity: 1;} }
        @-webkit-keyframes fadeout { from {bottom: 30px; opacity: 1;} to {bottom: 0; opacity: 0;} }
        @keyframes fadeout { from {bottom: 30px; opacity: 1;} to {bottom: 0; opacity: 0;} }
</style>
</head>
<body>

<div class="container">
    <h1>Aplikasi Utility Transaksi</h1>

    <div class="tab-buttons">
        <button class="tab-button active" data-tab="tab-scatter">Scatter 6 Kolom</button>
        <button class="tab-button" data-tab="tab-gallery">Galeri Paket (3 Slot)</button>
        <button class="tab-button" data-tab="tab-credit">Kalkulator Credit</button>
    </div>

    <div id="tab-scatter" class="tab-content active">
        <h2>Scatter 6 Kolom</h2>
        <div class="scatter-container">
            <div class="input-area">
                <p>Masukkan Data Otomatis (Max 6 Baris):</p>
                <textarea id="autoInput" rows="10" placeholder="Paste data transaksi di sini (max 6 baris, 1 baris = 1 kolom)."></textarea>
                <div id="autoInputWarning" style="color: orange; display: none;"></div>
                <div id="autoInputError" style="color: red; display: none;"></div>
                <p>Baris Terdeteksi: <span id="dataCount">0</span></p>
                <button id="autoDeleteBtn" class="danger"><i class="fas fa-trash"></i> Hapus Input Otomatis</button>
                <button id="clearScatter6Btn" class="danger" style="margin-left: 10px;">Bersihkan Semua Kolom</button>
            </div>
            
            <div class="manual-input-area">
                <p>Toggle TS: <input type="checkbox" id="tsToggle"> (Tambah "TS" ke User ID)</p>
                <div id="globalControls" style="margin-bottom: 10px;">
                    <button id="globalMinimizeBtn" style="background-color: #555;"><i class="fas fa-chevron-down"></i> Buka Semua Kolom</button>
                </div>
                <div class="input-cols">
                    <div class="input-col column-input minimized">
                        <span id="indicator1" class="indicator"></span>
                        <label>Kolom 1</label>
                        <textarea id="inputCol1" rows="3" placeholder="Data transaksi..."></textarea>
                        <button class="clear-col-btn danger" data-col="1">Hapus</button>
                    </div>
                    <div class="input-col column-input minimized">
                        <span id="indicator2" class="indicator"></span>
                        <label>Kolom 2</label>
                        <textarea id="inputCol2" rows="3" placeholder="Data transaksi..."></textarea>
                        <button class="clear-col-btn danger" data-col="2">Hapus</button>
                    </div>
                    <div class="input-col column-input minimized">
                        <span id="indicator3" class="indicator"></span>
                        <label>Kolom 3</label>
                        <textarea id="inputCol3" rows="3" placeholder="Data transaksi..."></textarea>
                        <button class="clear-col-btn danger" data-col="3">Hapus</button>
                    </div>
                    <div class="input-col column-input minimized">
                        <span id="indicator4" class="indicator"></span>
                        <label>Kolom 4</label>
                        <textarea id="inputCol4" rows="3" placeholder="Data transaksi..."></textarea>
                        <button class="clear-col-btn danger" data-col="4">Hapus</button>
                    </div>
                    <div class="input-col column-input minimized">
                        <span id="indicator5" class="indicator"></span>
                        <label>Kolom 5</label>
                        <textarea id="inputCol5" rows="3" placeholder="Data transaksi..."></textarea>
                        <button class="clear-col-btn danger" data-col="5">Hapus</button>
                    </div>
                    <div class="input-col column-input minimized">
                        <span id="indicator6" class="indicator"></span>
                        <label>Kolom 6</label>
                        <textarea id="inputCol6" rows="3" placeholder="Data transaksi..."></textarea>
                        <button class="clear-col-btn danger" data-col="6">Hapus</button>
                    </div>
                </div>
            </div>
        </div>
        
        <h3>Hasil Pemrosesan</h3>
        <div id="scatter6Results" class="result-container">
            </div>
    </div>

    <div id="tab-gallery" class="tab-content">
        <h2>Galeri Paket (3 Slot Gambar)</h2>
        <div class="gallery-3-container">
            <div class="gallery-input-area">
                <p>Masukkan Data Paket (User ID [spasi] Link1 Link2 Link3):</p>
                <textarea id="linkInput" rows="15" 
                    placeholder="Contoh:&#10;USER1 https://link1.jpg https://link2.png&#10;USER2 https://linkA.gif https://linkB.jpg https://linkC.webp"
                    oninput="handleInput()" onpaste="handleInput()"></textarea>
                <button onclick="clearAllData()" class="danger"><i class="fas fa-trash"></i> Hapus Semua Data Galeri</button>
            </div>
            <div class="image-display-area">
                <h3>Tampilan Galeri</h3>
                <div id="combinedImageSlot" class="combined-slot" onclick="openZoom()">
                    <img id="imgSlot1" src="placeholder" alt="Gambar 1">
                    <img id="imgSlot2" src="placeholder" alt="Gambar 2">
                    <img id="imgSlot3" src="placeholder" alt="Gambar 3">
                </div>
                <div class="pagination">
                    <button class="nav-btn" onclick="navigatePackage('prev')">← Prev</button>
                    <span>Paket <span id="currentPackageNum">0</span> dari <span id="maxPackageNum">0</span></span>
                    <button class="nav-btn" onclick="navigatePackage('next')">Next →</button>
                </div>
                <p id="combinedSlotUserid">Belum Ada Data</p>
            </div>
        </div>
    </div>

    <div id="tab-credit" class="tab-content">
        <div class="credit-calc">
            <div>
                <h2>Input Nominal</h2>
                <textarea id="creditData" rows="15" placeholder="Masukkan nominal per baris. Contoh:&#10;1000000&#10;-500.000&#10;5.000.000,00"></textarea>
                <button id="clearCreditBtn" class="danger"><i class="fas fa-trash"></i> Bersihkan</button>
            </div>
            <div class="credit-result">
                <h2>Total Credit</h2>
                <p class="total-display">Rp <span id="creditTotal">0</span></p>
                <button id="copyCreditBtn"><i class="fas fa-copy"></i> Salin Total Nominal</button>
            </div>
        </div>
    </div>
</div>

<div id="imageModal" class="modal">
    <div class="modal-content">
        <span class="modal-close close-btn">&times;</span>
        <h2>Tampilan Bukti Transaksi</h2>
        <div class="modal-info">
            <p id="imageInfo">Kolom X / User ID: N/A</p>
            <p id="colInfo">Kolom X</p>
            <p id="userIdInfo">User ID: N/A</p>
            <p id="ticketInfo">Kode Tiket: N/A</p>
        </div>
        
        <div id="modalNavigation" style="margin: 10px 0;">
            <button class="nav-btn" data-col="1">K1</button>
            <button class="nav-btn" data-col="2">K2</button>
            <button class="nav-btn" data-col="3">K3</button>
            <button class="nav-btn" data-col="4">K4</button>
            <button class="nav-btn" data-col="5">K5</button>
            <button class="nav-btn" data-col="6">K6</button>
        </div>

        <div class="modal-controls">
            <div>
                <button id="zoomOutBtn"><i class="fas fa-search-minus"></i> Zoom Out</button>
                <button id="zoomInBtn"><i class="fas fa-search-plus"></i> Zoom In</button>
                <button id="zoomResetBtn"><i class="fas fa-redo"></i> Reset (<span id="zoomIndicator">100%</span>)</button>
            </div>
        </div>
        
        <div class="images-scroll-container">
            <div id="imagesContainer">
                </div>
        </div>
    </div>
</div>

<div id="zoomModal" class="modal" onclick="closeZoom(event)">
    <div class="modal-content" style="max-width: 800px; margin-top: 2%;">
        <span class="modal-close close-btn" onclick="closeZoom(event)">&times;</span>
        <h2>Detail Paket Gambar</h2>
        <p id="zoomedUserid" style="font-weight: bold; font-size: 1.2em;">USER ID</p>

        <div class="modal-controls" style="justify-content: center; margin-bottom: 15px;">
            <button id="prevZoomBtn" class="zoom-nav-button" onclick="navigatePackage('prev')">← Prev Paket</button>
            <button id="nextZoomBtn" class="zoom-nav-button" onclick="navigatePackage('next')">Next Paket →</button>
        </div>
        
        <div class="images-scroll-container">
            <div id="zoomedContentWrapper">
                </div>
        </div>
        
        <div style="margin-top: 20px;">
            <label for="zoomLinkInput">Link Gambar (untuk disalin):</label>
            <textarea id="zoomLinkInput" rows="5" readonly></textarea>
            </div>
    </div>
</div>

<div id="lightboxModal" class="modal" onclick="closeLightbox()">
    <span class="lightbox-nav prev" onclick="event.stopPropagation(); prevImageLightbox();">&#10094;</span>
    <img id="lightboxImg">
    <span class="lightbox-nav next" onclick="event.stopPropagation(); nextImageLightbox();">&#10095;</span>
    <div id="lightboxCaption"></div>
</div>

<div id="toast"><span id="toastMessage"></span></div>

<script>
// Variabel dan Fungsi Global Galeri Paket (3 Slot)
let allPackagesData = [];
let currentPackageIndex = 0;
const packageSize = 3;
const placeholderImage = "https://via.placeholder.com/200x180/2c3e50/ffffff?text=Kosong";
let isZoomOpen = false;
let inputTimeout;
let currentLightboxImages = [];
let currentLightboxUserId = "";
let currentLightboxIndex = 0;
let isLightboxOpen = false;

// Data contoh (dikosongkan agar textarea kosong saat pertama kali dimuat)
const initialData = [];

// Fungsi yang diakses langsung dari HTML (harus menjadi properti window)
window.handleInput = function() {
    clearTimeout(inputTimeout);
    inputTimeout = setTimeout(loadImages, 50);
}

window.navigatePackage = function(direction) {
    let newIndex = currentPackageIndex;
    if (direction === 'next' && currentPackageIndex < allPackagesData.length - 1) {
        newIndex++;
    } else if (direction === 'prev' && currentPackageIndex > 0) {
        newIndex--;
    }

    if (newIndex !== currentPackageIndex) {
        currentPackageIndex = newIndex;
        updateGallery(currentPackageIndex);
    }
}

window.openZoom = function() {
    if (allPackagesData.length === 0 || allPackagesData[currentPackageIndex].links.filter(l => l.length > 0).length === 0) {
        return;
    }

    // Tutup modal lain jika terbuka
    const imageModal = document.getElementById('imageModal');
    if (imageModal.style.display === 'block') {
        imageModal.style.display = 'none';
        // Asumsi variabel isImageModalOpen ada di dalam DOMContentLoaded
    }
    if (isLightboxOpen) closeLightbox();

    isZoomOpen = true;

    const currentPackage = allPackagesData[currentPackageIndex];
    updateZoomDisplay(currentPackage.userid, currentPackage.links);
    updateZoomNavButtons();

    document.getElementById("zoomModal").style.display = "flex";
}

window.closeZoom = function(event) {
    const modal = document.getElementById("zoomModal");

    if (event && (event.target.classList.contains('zoom-nav-button') || event.target.tagName === 'IMG')) {
        event.stopPropagation();
        return;
    }

    if (!event || event.target === modal || event.target.classList.contains('close-btn')) {
        modal.style.display = "none";
        isZoomOpen = false;
        // Bersihkan konten
        document.getElementById('zoomedContentWrapper').innerHTML = '';
        document.getElementById('zoomedUserid').textContent = '';
        document.getElementById('zoomLinkInput').value = '';
    }
}

window.clearAllData = function() {
    allPackagesData = [];
    document.getElementById('linkInput').value = '';
    currentPackageIndex = 0;
    document.getElementById('maxPackageNum').textContent = 0;
    updateGallery(-1);
    showToast("Data Galeri Paket dihapus.");
}

window.closeLightbox = function() { // Lightbox untuk gambar di Scatter
    document.getElementById("lightboxModal").style.display = "none";
    isLightboxOpen = false;
    currentLightboxImages = [];
    currentLightboxUserId = "";
    currentLightboxIndex = 0;
}


document.addEventListener('DOMContentLoaded', function() {
    // ===== CACHE ELEMENT DOM UTAMA & VARIABEL GLOBAL (GABUNGAN) =====
    
    // Variabel yang diinisialisasi ulang di dalam scope DOMContentLoaded
    let scatterResults = [null, null, null, null, null, null];
    let undoData = [null, null, null, null, null, null];
    let isAllMinimized = true;
    let currentModalColumn = 1;
    let currentZoomLevel = 1;
    const ZOOM_STEP = 0.2;
    const MIN_ZOOM = 0.5;
    const MAX_ZOOM = 3;
    let isImageModalOpen = false; // Status untuk modal Scatter (#imageModal)

    // Elemen DOM untuk Scatter 6 Kolom
    const autoInput = document.getElementById('autoInput');
    const autoDeleteBtn = document.getElementById('autoDeleteBtn');
    const dataCount = document.getElementById('dataCount');
    const autoInputWarning = document.getElementById('autoInputWarning');
    const autoInputError = document.getElementById('autoInputError');
    const inputCol1 = document.getElementById('inputCol1');
    const inputCol2 = document.getElementById('inputCol2');
    const inputCol3 = document.getElementById('inputCol3');
    const inputCol4 = document.getElementById('inputCol4');
    const inputCol5 = document.getElementById('inputCol5');
    const inputCol6 = document.getElementById('inputCol6');
    const inputCols = [inputCol1, inputCol2, inputCol3, inputCol4, inputCol5, inputCol6];
    const clearScatter6Btn = document.getElementById('clearScatter6Btn');
    const scatter6Results = document.getElementById('scatter6Results');
    const modal = document.getElementById('imageModal');
    const closeBtn = document.querySelector('#imageModal .modal-close');
    const imageInfo = document.getElementById('imageInfo');
    const colInfo = document.getElementById('colInfo');
    const userIdInfo = document.getElementById('userIdInfo');
    const ticketInfo = document.getElementById('ticketInfo');
    const imagesContainer = document.getElementById('imagesContainer');
    const indicators = [
        document.getElementById('indicator1'), document.getElementById('indicator2'),
        document.getElementById('indicator3'), document.getElementById('indicator4'),
        document.getElementById('indicator5'), document.getElementById('indicator6')
    ];
    const clearColBtns = document.querySelectorAll('.clear-col-btn');
    const tsToggle = document.getElementById('tsToggle');
    const globalMinimizeBtn = document.getElementById('globalMinimizeBtn');
    const modalNavigation = document.getElementById('modalNavigation');
    const zoomInBtn = document.getElementById('zoomInBtn');
    const zoomOutBtn = document.getElementById('zoomOutBtn');
    const zoomResetBtn = document.getElementById('zoomResetBtn');
    const zoomIndicator = document.getElementById('zoomIndicator');
    
    // Elemen DOM untuk Kalkulator Credit
    const creditDataEl = document.getElementById('creditData');
    const clearCreditBtn = document.getElementById('clearCreditBtn');
    const creditTotalEl = document.getElementById('creditTotal');
    const copyCreditBtn = document.getElementById('copyCreditBtn');
    const toast = document.getElementById('toast');
    const toastMessage = document.getElementById('toastMessage');

    // Elemen DOM untuk Galeri Paket
    const galeri = {
        linkInput: document.getElementById('linkInput'),
        maxPackageNum: document.getElementById('maxPackageNum'),
        currentPackageNum: document.getElementById('currentPackageNum'),
        combinedSlot: document.getElementById('combinedImageSlot'),
        useridCaption: document.getElementById('combinedSlotUserid'),
        imgSlots: [
            document.getElementById('imgSlot1'),
            document.getElementById('imgSlot2'),
            document.getElementById('imgSlot3')
        ],
        zoomModal: document.getElementById('zoomModal'),
        zoomedUserid: document.getElementById('zoomedUserid'),
        zoomedContentWrapper: document.getElementById('zoomedContentWrapper'),
        prevZoomBtn: document.getElementById('prevZoomBtn'),
        nextZoomBtn: document.getElementById('nextZoomBtn'),
        zoomLinkInput: document.getElementById('zoomLinkInput')
    };
    
    // ===== FUNGSI UTILITY DASAR =====

    async function copyToClipboard(text, notificationMessage) {
        if (!text || text === 'N/A' || text === '0') {
            showToast('Tidak ada data yang valid untuk disalin.', 1500);
            return;
        }
        try {
            await navigator.clipboard.writeText(text);
            showToast(notificationMessage || `✅ Berhasil menyalin: ${text.substring(0, 20)}...`);
        } catch (err) {
            console.error('Gagal menyalin:', err);
            showToast('❌ Gagal menyalin. Silakan salin manual.', 3000);
        }
    }
    
    function showToast(message, duration = 2000) {
        toastMessage.textContent = message;
        toast.classList.add('show');
        setTimeout(() => {
            toast.classList.remove('show');
        }, duration);
    }
    
    function showProcessingIndicator(index) { indicators[index].style.backgroundColor = 'yellow'; }
    function hideProcessingIndicator(index) { indicators[index].style.backgroundColor = ''; }
    function hideAllMessages() {
        autoInputWarning.style.display = 'none';
        autoInputError.style.display = 'none';
    }

    // ===== FUNGSI SCATTER 6 KOLOM =====

    function updateDataCount() {
        const lines = autoInput.value.split('\n').filter(line => line.trim().length > 0);
        dataCount.textContent = lines.length;
        hideAllMessages();
        if (lines.length > 6) {
            autoInputWarning.textContent = `⚠️ Terdeteksi ${lines.length} baris. Hanya 6 baris pertama yang akan diproses.`;
            autoInputWarning.style.display = 'block';
        }
    }
    
    function parseInput(text, isTS) {
        if (!text) return null;
        const line = text.split('\n')[0].trim();
        const urlRegex = /(https?:\/\/[^\s]+)/g;
        const ticketRegex = /\b\d{17,20}\b/;
        const links = (line.match(urlRegex) || []).slice(0, 3);
        const ticket = (line.match(ticketRegex) || [])[0] || 'N/A';
        let userId = 'N/A';
        const words = line.split(/\s+/).filter(w => w.length > 0);
        for (const word of words) {
            if (!word.startsWith('http') && !ticketRegex.test(word) && word !== '-') {
                userId = word;
                break;
            }
        }
        if (isTS && userId !== 'N/A') { userId += ' TS'; }
        return { userId, ticket, links };
    }
    
    function processAutoInput() {
        const text = autoInput.value;
        const lines = text.split('\n').map(line => line.trim()).filter(line => line.length > 0);
        inputCols.forEach((input, index) => { input.value = lines[index] || ''; });
        processScatter6Data();
    }
    
    function processScatter6Data() {
        const isTS = tsToggle.checked;
        inputCols.forEach((input, index) => { scatterResults[index] = parseInput(input.value, isTS); });
        renderScatterResults();
    }
    
    function renderScatterResults() {
        scatter6Results.innerHTML = '';
        scatterResults.forEach((result, index) => {
            const colNum = index + 1;
            const hasData = result && (result.userId !== 'N/A' || result.links.filter(l => l).length > 0);
            const resultBlock = document.createElement('div');
            resultBlock.className = 'result-block' + (hasData ? ' has-data' : '');
            const linksHTML = result ? result.links.map((link, i) => 
                link 
                ? `<button class="view-image-btn" data-col="${colNum}" data-link="${link}">🔗 Bukti ${i + 1}</button>` 
                : `<button class="view-image-btn no-link" disabled>Bukti ${i + 1} (Kosong)</button>`
            ).join('') : '';
            const userId = result ? result.userId : 'N/A';
            const ticket = result ? result.ticket : 'N/A';
            const undoBtnHTML = undoData[index] ? `<button class="undo-btn" data-col="${colNum}">↩️ Undo Cancel</button>` : '';

            resultBlock.innerHTML = `
                <h4>Kolom ${colNum}</h4>
                <div class="result-item">
                    <label>User ID:</label>
                    <span id="uidCol${colNum}" class="data-text">${userId}</span>
                    <button class="copy-btn" data-text="${userId}">📋</button>
                </div>
                <div class="result-item">
                    <label>Kode Tiket:</label>
                    <span id="ticketCol${colNum}" class="data-text">${ticket}</span>
                    <button class="copy-btn" data-text="${ticket}">📋</button>
                </div>
                <div class="link-group">${linksHTML}</div>
                <div class="action-group">
                    <button class="cancel-btn danger" data-col="${colNum}">❌ Cancel</button>
                    ${undoBtnHTML}
                </div>
            `;
            scatter6Results.appendChild(resultBlock);
        });
    }

    function updateResultsWithTS() { processScatter6Data(); }
    
    // --- Modal Scatter & Zoom ---
    function loadModalContent(colIndex) {
        const result = scatterResults[colIndex - 1];
        if (!result) return;
        currentModalColumn = colIndex;
        imageInfo.textContent = `Kolom ${colIndex} / User ID: ${result.userId}`;
        colInfo.textContent = `Kolom ${colIndex}`;
        userIdInfo.textContent = `User ID: ${result.userId}`;
        ticketInfo.textContent = `Kode Tiket: ${result.ticket}`;

        imagesContainer.innerHTML = '';
        result.links.forEach(link => {
            if (link) {
                const img = document.createElement('img');
                img.src = link;
                img.alt = 'Bukti Transaksi';
                // Tambahkan event untuk membuka lightbox
                img.onclick = () => openLightbox(link, result.userId); 
                imagesContainer.appendChild(img);
            }
        });
        updateModalNavigationButtons();
    }

    function openModal(colIndex) {
        // Tutup modal Galeri jika terbuka
        if (isZoomOpen) window.closeZoom();
        if (isLightboxOpen) closeLightbox();

        loadModalContent(colIndex);
        modal.style.display = 'block';
        isImageModalOpen = true;
        resetZoom();
    }

    function closeModal() {
        modal.style.display = 'none';
        isImageModalOpen = false;
    }

    function navigateToColumn(targetCol) {
        if (targetCol >= 1 && targetCol <= 6) {
            const result = scatterResults[targetCol - 1];
            if (result && result.links.filter(l => l).length > 0) {
                 loadModalContent(targetCol);
            } else {
                showToast(`Kolom ${targetCol} tidak memiliki link gambar.`);
            }
        }
    }
    
    function updateModalNavigationButtons() {
        const navButtons = modalNavigation.querySelectorAll('.nav-btn');
        navButtons.forEach(btn => {
            const btnCol = parseInt(btn.getAttribute('data-col'));
            btn.classList.remove('active-col');
            const result = scatterResults[btnCol - 1];
            btn.disabled = !result || result.links.filter(l => l).length === 0;
            if (btnCol === currentModalColumn) {
                btn.classList.add('active-col');
            }
        });
    }
    
    function applyZoom() {
        imagesContainer.style.transform = `scale(${currentZoomLevel})`;
        zoomIndicator.textContent = `${Math.round(currentZoomLevel * 100)}%`;
        imagesContainer.style.transformOrigin = 'center center';
    }
    
    function zoomIn() { currentZoomLevel = Math.min(MAX_ZOOM, currentZoomLevel + ZOOM_STEP); applyZoom(); }
    function zoomOut() { currentZoomLevel = Math.max(MIN_ZOOM, currentZoomLevel - ZOOM_STEP); applyZoom(); }
    function resetZoom() { currentZoomLevel = 1; applyZoom(); }

    // ===== FUNGSI GALERI PAKET (Diakses dari luar scope DOMContentLoaded) =====

    function loadImages() {
        const rawLines = galeri.linkInput.value
            .split('\n')
            .map(line => line.trim())
            .filter(line => line.length > 0);
        allPackagesData = [];
        const urlRegex = /(https?:\/\/[^\s]+)/g;
        rawLines.forEach((line) => {
            const urls = line.match(urlRegex) || [];
            const words = line.split(/\s+/).filter(w => w.length > 0);
            let userid = 'N/A';
            if (words.length > 0 && !words[0].startsWith('http')) {
                userid = words[0];
            }
            if (urls.length >= 1) {
                const links = urls.slice(0, packageSize);
                while (links.length < packageSize) { links.push(""); }
                allPackagesData.push({ userid: userid, links: links });
            }
        });
        galeri.maxPackageNum.textContent = allPackagesData.length;
        if (allPackagesData.length > 0) {
            currentPackageIndex = Math.min(currentPackageIndex, allPackagesData.length - 1);
            currentPackageIndex = Math.max(0, currentPackageIndex);
            updateGallery(currentPackageIndex);
        } else {
            currentPackageIndex = 0;
            galeri.currentPackageNum.textContent = 0;
            updateGallery(-1);
        }
    }

    function updateGallery(index) {
        const validPackages = allPackagesData.length;
        let currentPackage = { userid: 'N/A', links: ["", "", ""] };
        if (index >= 0 && index < validPackages) {
            currentPackage = allPackagesData[index];
            galeri.combinedSlot.style.pointerEvents = 'auto';
            galeri.combinedSlot.style.opacity = 1;
        } else {
            galeri.combinedSlot.style.pointerEvents = 'none';
            galeri.combinedSlot.style.opacity = 0.5;
        }
        galeri.combinedSlot.setAttribute('data-userid', currentPackage.userid);
        galeri.useridCaption.textContent = currentPackage.userid === 'N/A' ? 'Belum Ada Data' : `USER ID: ${currentPackage.userid}`;
        let validLinkCount = 0;
        for (let i = 0; i < packageSize; i++) {
            const link = currentPackage.links[i] || "";
            const imgSlot = galeri.imgSlots[i];
            if (link) {
                imgSlot.src = link;
                imgSlot.style.display = 'block';
                imgSlot.setAttribute('data-link', link);
                validLinkCount++;
            } else {
                imgSlot.src = placeholderImage;
                imgSlot.style.display = (index === -1 && i === 1) ? 'block' : 'none';
                imgSlot.setAttribute('data-link', "");
            }
        }
        galeri.currentPackageNum.textContent = validPackages > 0 ? index + 1 : 0;
        if (isZoomOpen) {
            updateZoomDisplay(currentPackage.userid, currentPackage.links);
            updateZoomNavButtons();
        }
    }

    function updateZoomDisplay(userid, links) {
        galeri.zoomedContentWrapper.innerHTML = '';
        galeri.zoomLinkInput.value = links.filter(l => l).join('\n');
        links.forEach(link => {
            if (link) {
                const img = document.createElement('img');
                img.src = link;
                img.alt = 'Zoomed Image';
                galeri.zoomedContentWrapper.appendChild(img);
            }
        });
        galeri.zoomedUserid.textContent = userid;
    }

    function updateZoomNavButtons() {
        galeri.prevZoomBtn.disabled = (currentPackageIndex === 0);
        galeri.nextZoomBtn.disabled = (currentPackageIndex >= allPackagesData.length - 1);
    }
    
    // ===== FUNGSI LIGHTBOX (untuk Scatter Modal) =====
    
    function getCurrentTransaksiImages(userId) {
        const result = scatterResults[currentModalColumn - 1];
        return result && result.userId === userId ? result.links.filter(l => l) : [];
    }

    function openLightbox(imgUrl, userId) {
        if (isZoomOpen) window.closeZoom();
        if (isImageModalOpen) closeModal(); // Close scatter modal preview

        const modal = document.getElementById("lightboxModal");
        const img = document.getElementById("lightboxImg");
        const caption = document.getElementById("lightboxCaption");

        currentLightboxImages = getCurrentTransaksiImages(userId);
        currentLightboxUserId = userId;
        currentLightboxIndex = currentLightboxImages.findIndex(img => img === imgUrl);
        if (currentLightboxIndex === -1) currentLightboxIndex = 0;

        img.src = currentLightboxImages[currentLightboxIndex];
        caption.innerText = `User ID: ${userId} (${currentLightboxIndex + 1}/${currentLightboxImages.length})`;
        modal.style.display = "flex";
        isLightboxOpen = true;
        updateNavButtonsLightbox();
    }
    
    function prevImageLightbox() {
        if (currentLightboxImages.length <= 1) return;
        currentLightboxIndex = (currentLightboxIndex - 1 + currentLightboxImages.length) % currentLightboxImages.length;
        updateLightboxImage();
    }

    function nextImageLightbox() {
        if (currentLightboxImages.length <= 1) return;
        currentLightboxIndex = (currentLightboxIndex + 1) % currentLightboxImages.length;
        updateLightboxImage();
    }

    function updateLightboxImage() {
        const img = document.getElementById("lightboxImg");
        const caption = document.getElementById("lightboxCaption");
        img.src = currentLightboxImages[currentLightboxIndex];
        caption.innerText = `User ID: ${currentLightboxUserId} (${currentLightboxIndex + 1}/${currentLightboxImages.length})`;
        updateNavButtonsLightbox();
    }
    
    function updateNavButtonsLightbox() {
        const prevBtn = document.querySelector('#lightboxModal .prev');
        const nextBtn = document.querySelector('#lightboxModal .next');

        if (currentLightboxImages.length <= 1) {
            prevBtn.style.opacity = '0.3';
            nextBtn.style.opacity = '0.3';
            prevBtn.style.pointerEvents = 'none';
            nextBtn.style.pointerEvents = 'none';
        } else {
            prevBtn.style.opacity = '1';
            nextBtn.style.opacity = '1';
            prevBtn.style.pointerEvents = 'auto';
            nextBtn.style.pointerEvents = 'auto';
        }
    }


    // ===== FUNGSI CREDIT CALCULATOR =====

    function processCreditData() {
        const text = creditDataEl.value;
        const lines = text.split('\n');
        let totalCredit = 0;
        const numberRegex = /^\s*(\-?\d[\d\.,]*)/;

        lines.forEach(line => {
            const match = line.match(numberRegex);
            if (match) {
                let numStr = match[1].replace(/,/g, '').replace(/\./g, '');
                const isNegative = numStr.startsWith('-');
                if(isNegative) { numStr = numStr.substring(1); }
                const digitsOnly = numStr.match(/\d/g)?.join('') || '0'; 
                const value = parseInt(digitsOnly, 10);
                if (!isNaN(value)) {
                    totalCredit += isNegative ? -value : value;
                }
            }
        });
        creditTotalEl.textContent = totalCredit.toLocaleString('id-ID');
    }

    // ===== EVENT LISTENERS =====

    // --- Tab Functionality ---
    const tabButtons = document.querySelectorAll('.tab-button');
    const tabContents = document.querySelectorAll('.tab-content');
    tabButtons.forEach(button => {
        button.addEventListener('click', () => {
            const tabId = button.getAttribute('data-tab');
            tabButtons.forEach(btn => btn.classList.remove('active'));
            button.classList.add('active');
            tabContents.forEach(content => content.classList.remove('active'));
            document.getElementById(tabId).classList.add('active');
        });
    });
    if (tabButtons.length > 0) { tabButtons[0].click(); }

    // --- Scatter General Events ---
    globalMinimizeBtn.addEventListener('click', function() {
        const allColumns = document.querySelectorAll('.column-input');
        if (isAllMinimized) {
            allColumns.forEach(col => col.classList.remove('minimized'));
            globalMinimizeBtn.innerHTML = '<i class="fas fa-chevron-up"></i> Minimize Semua Kolom';
            isAllMinimized = false;
        } else {
            allColumns.forEach(col => col.classList.add('minimized'));
            globalMinimizeBtn.innerHTML = '<i class="fas fa-chevron-down"></i> Buka Semua Kolom';
            isAllMinimized = true;
        }
    });

    autoInput.addEventListener('input', function() { updateDataCount(); processAutoInput(); });
    autoDeleteBtn.addEventListener('click', function() { autoInput.value = ''; updateDataCount(); processAutoInput(); });
    clearScatter6Btn.addEventListener('click', function() {
        inputCols.forEach(input => input.value = '');
        scatter6Results.innerHTML = '';
        scatterResults = [null, null, null, null, null, null];
        undoData = [null, null, null, null, null, null];
        updateDataCount();
        hideAllMessages();
    });

    clearColBtns.forEach(btn => {
        btn.addEventListener('click', function() {
            const colNum = parseInt(this.getAttribute('data-col'));
            inputCols[colNum - 1].value = '';
            undoData[colNum - 1] = null;
            showProcessingIndicator(colNum - 1);
            setTimeout(() => { processScatter6Data(); hideProcessingIndicator(colNum - 1); }, 300);
        });
    });

    tsToggle.addEventListener('change', updateResultsWithTS);

    inputCols.forEach((input, index) => {
        input.addEventListener('input', function() {
            showProcessingIndicator(index);
            setTimeout(() => { processScatter6Data(); hideProcessingIndicator(index); }, 300);
        });
    });
    
    // Delegasi Event Listener untuk hasil render (Copy, View Image, Cancel, Undo)
    scatter6Results.addEventListener('click', function(e) {
        const copyBtn = e.target.closest('.copy-btn');
        const viewBtn = e.target.closest('.view-image-btn');
        const cancelBtn = e.target.closest('.cancel-btn');
        const undoBtn = e.target.closest('.undo-btn');

        if (copyBtn) {
            const textToCopy = copyBtn.getAttribute('data-text') || copyBtn.previousElementSibling.textContent;
            copyToClipboard(textToCopy, `✅ Berhasil menyalin: ${textToCopy.substring(0, 20)}...`);
        } else if (viewBtn && !viewBtn.disabled) {
            const colNum = parseInt(viewBtn.getAttribute('data-col'));
            openModal(colNum);
        } else if (cancelBtn) {
            const colNum = parseInt(cancelBtn.getAttribute('data-col'));
            const colIndex = colNum - 1;
            undoData[colIndex] = inputCols[colIndex].value;
            inputCols[colIndex].value = '';
            processScatter6Data();
            showToast(`Kolom ${colNum} Dibatalkan. Klik 'Undo Cancel' untuk mengembalikan.`);
        } else if (undoBtn) {
            const colNum = parseInt(undoBtn.getAttribute('data-col'));
            const colIndex = colNum - 1;
            inputCols[colIndex].value = undoData[colIndex];
            undoData[colIndex] = null;
            processScatter6Data();
            showToast(`Kolom ${colNum} berhasil dikembalikan.`);
        }
    });

    // --- Modal Scatter Events ---
    closeBtn.addEventListener('click', closeModal);
    modal.addEventListener('click', function(e) { if (e.target === modal) { closeModal(); } });
    modalNavigation.addEventListener('click', function(e) {
        const navBtn = e.target.closest('.nav-btn');
        if (navBtn) { navigateToColumn(parseInt(navBtn.getAttribute('data-col'))); }
    });
    zoomInBtn.addEventListener('click', zoomIn);
    zoomOutBtn.addEventListener('click', zoomOut);
    zoomResetBtn.addEventListener('click', resetZoom);
    
    // --- Credit Calculator Events ---
    creditDataEl.addEventListener('input', processCreditData);
    clearCreditBtn.addEventListener('click', function() { creditDataEl.value = ''; processCreditData(); showToast('Data Credit Dihapus.'); });
    copyCreditBtn.addEventListener('click', function() { copyToClipboard(creditTotalEl.textContent, '✅ Total Credit berhasil disalin!'); });

    // --- Navigasi Keyboard Global (Scatter & Galeri & Lightbox) ---
    document.addEventListener('keydown', function(e) {
        if (e.key === "Escape") {
            if (isZoomOpen) { window.closeZoom(e); }
            else if (isImageModalOpen) { closeModal(); }
            else if (isLightboxOpen) { window.closeLightbox(); }
        } else if (e.key === "ArrowLeft" || e.key === "ArrowRight") {
            if (isZoomOpen) { 
                e.preventDefault();
                window.navigatePackage(e.key === "ArrowLeft" ? 'prev' : 'next');
            } else if (isImageModalOpen) { 
                e.preventDefault();
                const nextCol = currentModalColumn < 6 ? currentModalColumn + 1 : 1;
                const prevCol = currentModalColumn > 1 ? currentModalColumn - 1 : 6;
                navigateToColumn(e.key === "ArrowRight" ? nextCol : prevCol);
            } else if (isLightboxOpen) { 
                e.preventDefault();
                e.key === "ArrowLeft" ? prevImageLightbox() : nextImageLightbox();
            }
        }
    });

    // --- Inisialisasi Awal ---
    const initialText = initialData.map(p => `${p.userid} ${p.links.join(' ')}`).join('\n');
    document.getElementById('linkInput').value = initialText;
    loadImages(); 
    updateDataCount();
    processScatter6Data();
    processCreditData();
});
</script>

</body>
</html>
