<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Galeri Otomatis & Data Scatter</title>
    <style>
        /* ======================== STYLING UMUM & BACKGROUND ======================== */
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #1a1a2e; /* Latar Belakang Gelap Keren */
            color: #e0e0e0;
            margin: 0;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .container, .scatter-section {
            width: 100%;
            max-width: 800px;
            margin: 20px auto;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.5), 0 0 40px rgba(70, 0, 150, 0.3); /* Shadow dengan Aksen Ungu */
            background: #2a2a4a; /* Warna Card Sedikit Lebih Terang dari Background */
            border: 1px solid #4a4a7a;
        }

        h1, h2, h3 {
            color: #8c8cff; /* Aksen Biru-Ungu */
            text-align: center;
        }

        p {
            line-height: 1.6;
        }

        /* --- Input Area --- */
        #linkInput, #scatterTextarea, #zoomLinkInput {
            width: 100%;
            padding: 12px;
            margin-bottom: 15px;
            border-radius: 8px;
            border: 1px solid #4a4a7a;
            background-color: #1a1a2e;
            color: #e0e0e0;
            font-size: 14px;
            box-sizing: border-box;
            resize: vertical;
        }

        /* --- Tombol Umum --- */
        .button-group {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-bottom: 15px;
        }

        button, .ts-toggle {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease;
        }

        #clearDataBtn {
            background-color: #e74c3c;
            color: white;
        }
        #clearDataBtn:hover {
            background-color: #c0392b;
        }
        
        .btn.danger {
            background-color: #e74c3c;
            color: white;
        }
        .btn.danger:hover {
            background-color: #c0392b;
        }

        .ts-toggle {
            background-color: #34495e;
            color: #ecf0f1;
        }

        .ts-toggle.on {
            background-color: #2ecc71;
            color: #1a1a2e;
        }
        .ts-toggle.on:hover {
            background-color: #27ae60;
        }

        /* --- Garis Pembatas --- */
        hr {
            border: 0;
            height: 1px;
            background-image: linear-gradient(to right, rgba(0, 0, 0, 0), #8c8cff, rgba(0, 0, 0, 0));
            margin: 25px 0;
        }

        /* --- Info Paket --- */
        .package-info {
            text-align: center;
            font-size: 1.1em;
            margin-top: 15px;
            color: #e0e0e0;
        }

        /* ======================== GALERI (CARD MINI) ======================== */
        .gallery-container {
            display: flex;
            justify-content: center;
            margin-top: 20px;
        }

        .combined-image-slot {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 15px;
            border-radius: 10px;
            background: #3a3a5a; /* Latar belakang card mini */
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.4);
            cursor: pointer;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            width: 250px; /* Ukuran Card Mini */
            height: 350px; /* Tinggi Card Mini */
            position: relative;
        }
        
        .combined-image-slot:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 20px rgba(140, 140, 255, 0.5); /* Efek hover yang mencolok */
        }

        .caption-userid {
            position: absolute;
            top: 10px;
            background: rgba(0, 0, 0, 0.6);
            color: #ffcc00; /* Warna kuning emas untuk User ID */
            padding: 5px 10px;
            border-radius: 5px;
            font-weight: bold;
            font-size: 1.0em;
            z-index: 10;
        }

        .combined-image-slot img {
            width: 100%;
            max-height: 100px; /* Tinggi gambar lebih mini */
            object-fit: cover;
            border-radius: 6px;
            margin-bottom: 5px;
            transition: opacity 0.3s;
            border: 2px solid #5a5a8a;
        }

        .combined-image-slot img:last-of-type {
            margin-bottom: 0;
        }

        /* ======================== MODAL ZOOM (LIGHTBOX) ======================== */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0, 0, 0, 0.95);
            justify-content: center;
            align-items: center;
            flex-direction: column;
        }

        .close-btn {
            position: absolute;
            top: 20px;
            right: 35px;
            color: #f1f1f1;
            font-size: 40px;
            font-weight: bold;
            transition: 0.3s;
        }

        .close-btn:hover,
        .close-btn:focus {
            color: #bbb;
            text-decoration: none;
            cursor: pointer;
        }

        .zoomed-userid {
            position: absolute;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            color: #ffcc00;
            font-size: 1.5em;
            font-weight: bold;
            z-index: 1010;
            background: rgba(0, 0, 0, 0.5);
            padding: 5px 15px;
            border-radius: 8px;
        }

        .zoomed-content-area {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 90%;
            max-width: 900px;
            margin: 0 auto;
        }

        .zoomed-content-wrapper {
            display: flex;
            flex-direction: column;
            gap: 10px;
            max-height: 80vh;
            overflow-y: auto;
            padding: 10px;
            scroll-behavior: smooth;
        }

        .zoomed-content-wrapper img {
            width: auto;
            max-width: 100%;
            height: auto;
            display: block;
            border-radius: 8px;
            border: 3px solid #8c8cff;
        }

        .zoom-nav-button {
            background: rgba(70, 0, 150, 0.7);
            color: white;
            padding: 10px;
            border-radius: 50%;
            font-size: 2em;
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 10px;
        }
        
        .zoom-nav-button:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }

        /* ======================== SCATTER SECTION ======================== */

        .judul-glow {
            text-shadow: 0 0 8px #ffcc00, 0 0 15px rgba(255, 204, 0, 0.5);
        }
        
        /* Hasil Transaksi Multi-line */
        .hasil-transaksi {
            background: #3a3a5a;
            padding: 15px;
            border-radius: 10px;
            margin-top: 15px;
            border: 1px solid #5a5a8a;
        }

        .hasil-item {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
            padding: 5px;
            border-radius: 5px;
            transition: background-color 0.5s;
        }
        .hasil-item label {
            font-weight: bold;
            color: #8c8cff;
            min-width: 100px;
        }
        .hasil-text {
            flex-grow: 1;
            padding: 0 10px;
            word-break: break-all;
        }
        .hasil-item .copy-btn {
            background-color: transparent;
            color: #ffcc00;
            padding: 5px 10px;
            font-size: 1.2em;
        }
        .red-bg {
            background-color: #c0392b; /* Efek menyalin */
        }

        .gambar-container-multi {
            display: flex;
            gap: 10px;
            margin-top: 15px;
            overflow-x: auto;
            padding-bottom: 10px; /* Untuk scrollbar */
        }
        .gambar-slot-multi {
            flex: 1 1 150px; /* Ukuran gambar di scatter section */
            text-align: center;
            border: 1px dashed #5a5a8a;
            padding: 5px;
            border-radius: 5px;
            min-width: 120px;
        }
        .gambar-slot-multi img {
            width: 100%;
            height: 100px;
            object-fit: cover;
            border-radius: 5px;
            cursor: zoom-in;
            border: 1px solid #8c8cff;
        }
        .gambar-slot-multi div {
            color: #aaa;
            font-size: 0.9em;
        }
        .userid-label {
            font-size: 0.8em;
            color: #ffcc00 !important;
            margin-top: 5px;
        }


        /* ======================== LIGHTBOX SCATTER ======================== */
        .lightbox-modal {
            display: none; 
            position: fixed; 
            z-index: 2000; 
            left: 0;
            top: 0;
            width: 100%; 
            height: 100%; 
            overflow: auto; 
            background-color: rgba(0,0,0,0.95); 
            align-items: center;
            justify-content: center;
            flex-direction: column;
        }
        .lightbox-modal img {
            max-width: 90%;
            max-height: 90vh;
            margin: auto;
            display: block;
            border-radius: 8px;
            animation-name: zoom;
            animation-duration: 0.6s;
            border: 4px solid #8c8cff;
        }
        .lightbox-caption {
            margin-top: 15px;
            color: #ffcc00;
            font-size: 1.5em;
            font-weight: bold;
        }

        .lightbox-modal .close {
            position: absolute;
            top: 15px;
            right: 35px;
            color: #f1f1f1;
            font-size: 40px;
            font-weight: bold;
            transition: 0.3s;
        }
        .lightbox-modal .close:hover,
        .lightbox-modal .close:focus {
            color: #bbb;
            text-decoration: none;
            cursor: pointer;
        }

        .lightbox-modal .nav-btn {
            cursor: pointer;
            position: absolute;
            top: 50%;
            width: auto;
            padding: 16px;
            margin-top: -50px;
            color: white;
            font-weight: bold;
            font-size: 20px;
            transition: 0.6s ease;
            border-radius: 0 3px 3px 0;
            user-select: none;
            background-color: rgba(0,0,0,0.5);
            z-index: 2001;
        }
        .lightbox-modal .nav-btn.prev {
            left: 0;
            border-radius: 3px 0 0 3px;
        }
        .lightbox-modal .nav-btn.next {
            right: 0;
            border-radius: 3px 0 0 3px;
        }
        .lightbox-modal .nav-btn:hover {
            background-color: rgba(0,0,0,0.8);
        }

        @keyframes zoom {
            from {transform:scale(0)} 
            to {transform:scale(1)}
        }
        
        /* Media Queries untuk Responsif */
        @media (max-width: 600px) {
            body {
                padding: 10px;
            }
            .container, .scatter-section {
                padding: 15px;
            }
            .combined-image-slot {
                width: 200px;
                height: 300px;
            }
            .combined-image-slot img {
                max-height: 80px;
            }
            .zoom-nav-button {
                font-size: 1.5em;
                width: 40px;
                height: 40px;
            }
            .lightbox-modal .nav-btn {
                font-size: 16px;
                padding: 10px;
            }
        }
    </style>
</head>
<body>

<div class="container">
    <h1>📸 Galeri Gambar Otomatis & Zoom Navigasi</h1>
    <p style="text-align: center; color: #8c8cff;">**Tempel/Ketik** data. Format: **USERID link_gambar1 link_gambar2 link_gambar3**</p>

    <textarea id="linkInput" 
              placeholder="Tempelkan data paket di sini. Setiap baris adalah satu paket." 
              rows="8" 
              oninput="handleInput()"
              onpaste="handleInput()"></textarea>
    
    <div class="button-group">
        <button id="clearDataBtn" onclick="clearAllData()">🗑️ Hapus Semua Data</button>
    </div>

    <hr>

    <div class="gallery-container">
        
        <div class="combined-image-slot" id="combinedImageSlot" onclick="openZoom()">
            
            <p class="caption-userid" id="combinedSlotUserid">USER ID</p>
            
            <img id="imgSlot1" data-link="" src="https://via.placeholder.com/200x90/2c3e50/ffffff?text=Slot+1" alt="Slot 1">
            <img id="imgSlot2" data-link="" src="https://via.placeholder.com/200x90/2c3e50/ffffff?text=Slot+2" alt="Slot 2">
            <img id="imgSlot3" data-link="" src="https://via.placeholder.com/200x90/2c3e50/ffffff?text=Slot+3" alt="Slot 3">
        </div>
        
    </div>

    <p class="package-info">
        Paket: <span id="currentPackageNum">0</span> / <span id="maxPackageNum">0</span>
    </p>

</div>

<div id="zoomModal" class="modal" onclick="closeZoom(event)">
    <span class="close-btn">&times;</span>
    <span id="zoomedUserid" class="zoomed-userid"></span> 
    
    <div class="zoomed-content-area">
        
        <button class="zoom-nav-button" id="prevZoomBtn" onclick="navigatePackage('prev')">&#9664;</button>
        
        <div class="zoomed-content-wrapper" id="zoomedContentWrapper">
            </div>

        <button class="zoom-nav-button" id="nextZoomBtn" onclick="navigatePackage('next')">&#9654;</button>
    </div>
    
    <textarea id="zoomLinkInput" class="zoom-link-input-area" placeholder="Link akan muncul di sini saat zoom"></textarea>
            
    <div id="caption">Geser paket menggunakan tombol navigasi (&#9664; / &#9654;) atau tombol panah Kiri/Kanan pada keyboard.</div>
</div>

<div class="scatter-section">
    <h3 class="judul-glow">💫 LINE TOGEL 💫</h3>
    <h2>💣 DATA SCATTER MAHJONG</h2>

    <div class="button-group" style="margin: 10px 0;">
        <button id="tsToggleBtn" onclick="toggleTSMode()" class="ts-toggle">TS: OFF</button>
    </div>

    <textarea id="scatterTextarea" class="input-textarea" placeholder="Tempelkan 1–7 baris data (satu baris = satu transaksi)..."></textarea>

    <div class="button-group">
        <button onclick="hapusScatter()" class="btn danger">🧹 Hapus</button>
    </div>

    <div id="hasilScatterContainer"></div>
</div>

<div id="lightboxModal" class="lightbox-modal" style="display:none;">
    <span class="close" onclick="closeLightbox()">&times;</span>
    <span class="nav-btn prev" onclick="prevImage()">&lsaquo;</span>
    <span class="nav-btn next" onclick="nextImage()">&rsaquo;</span>
    <img id="lightboxImg" src="" alt="Zoomed Image" />
    <div id="lightboxCaption" class="lightbox-caption">User ID: -</div>
</div>

<script>
    /* ======================== JAVASCRIPT LAMA TETAP DIPERTAHANKAN ======================== */
    let allPackagesData = []; 
    let currentPackageIndex = 0; 
    const packageSize = 3; 
    const placeholderImage = "https://via.placeholder.com/200x90/2c3e50/ffffff?text=Kosong"; 
    let isZoomOpen = false;

    // Data contoh (tetap dipertahankan untuk inisialisasi awal yang mudah)
    const initialData = [
        // Contoh data bisa ditambahkan di sini, misal:
        // { userid: 'User123', links: ['https://example.com/img1.jpg', 'https://example.com/img2.jpg', ''] },
    ];
    
    // --- Handler Input Utama Otomatis ---
    let inputTimeout;
    function handleInput() {
        clearTimeout(inputTimeout);
        inputTimeout = setTimeout(() => {
            loadImages();
        }, 50);
    }

    // --- Fungsi Utama untuk Memuat Gambar (dari Textarea) ---
    function loadImages() {
        const inputArea = document.getElementById('linkInput');
        
        const rawLines = inputArea.value
            .split('\n')
            .map(line => line.trim())
            .filter(line => line.length > 0);
        
        allPackagesData = [];
        const urlRegex = /(https?:\/\/[^\s]+)/g;

        rawLines.forEach((line) => {
            const urls = line.match(urlRegex) || [];
            
            const words = line.split(/\s+/).filter(w => w.length > 0);
            let userid = 'N/A';
            
            if (words.length > 0 && !words[0].startsWith('http')) {
                userid = words[0];
            }

            if (urls.length >= 1) { 
                const links = urls.slice(0, packageSize); 
                
                while (links.length < packageSize) {
                    links.push(""); 
                }
                
                allPackagesData.push({ userid: userid, links: links });
            }
        });

        if (allPackagesData.length === 0) {
             // Tidak melakukan apa-apa, biarkan updateGallery(-1) membersihkan
        }
        
        document.getElementById('maxPackageNum').textContent = allPackagesData.length;
        
        if (allPackagesData.length > 0) {
            currentPackageIndex = Math.min(currentPackageIndex, allPackagesData.length - 1);
            currentPackageIndex = Math.max(0, currentPackageIndex);
            updateGallery(currentPackageIndex);
        } else {
            currentPackageIndex = 0;
            document.getElementById('currentPackageNum').textContent = 0;
            updateGallery(-1); // Bersihkan tampilan
        }
    }

    // --- Fungsi untuk Mengupdate Tampilan Galeri ---
    function updateGallery(index) {
        const imgSlots = [
            document.getElementById('imgSlot1'),
            document.getElementById('imgSlot2'),
            document.getElementById('imgSlot3')
        ];
        
        const combinedSlot = document.getElementById('combinedImageSlot');
        const useridCaption = document.getElementById('combinedSlotUserid');
        const validPackages = allPackagesData.length;
        
        let currentPackage = { userid: 'N/A', links: ["", "", ""] };
        
        if (index >= 0 && index < validPackages) {
            currentPackage = allPackagesData[index];
            combinedSlot.style.pointerEvents = 'auto'; // Dapat diklik
        } else {
            combinedSlot.style.pointerEvents = 'none'; // Tidak dapat diklik
            currentPackage.userid = 'N/A'; // Pastikan kondisi default saat kosong
        }

        combinedSlot.setAttribute('data-userid', currentPackage.userid);
        useridCaption.textContent = currentPackage.userid === 'N/A' ? 'Belum Ada Data' : `USER ID: ${currentPackage.userid}`;

        let validLinkCount = 0;
        for (let i = 0; i < packageSize; i++) {
            const link = currentPackage.links[i] || "";

            if (link) {
                imgSlots[i].src = link;
                imgSlots[i].style.display = 'block'; 
                imgSlots[i].setAttribute('data-link', link);
                validLinkCount++;
            } else {
                imgSlots[i].src = placeholderImage;
                // Tampilkan placeholder tengah saja jika tidak ada data sama sekali
                imgSlots[i].style.display = (index === -1 && i === 1) ? 'block' : 'none'; 
                imgSlots[i].setAttribute('data-link', "");
            }
        }
        
        // Atur opasitas hanya jika tidak ada link yang valid
        if (validLinkCount > 0) {
            combinedSlot.style.opacity = 1;
        } else {
            combinedSlot.style.opacity = 0.5;
        }

        document.getElementById('currentPackageNum').textContent = validPackages > 0 ? index + 1 : 0;
        
        if (isZoomOpen) {
            updateZoomDisplay(currentPackage.userid, currentPackage.links);
            updateZoomNavButtons();
        }
    }

    // --- Fungsi Navigasi (Untuk Tombol Fisik & Keyboard) ---
    function navigatePackage(direction) {
        let newIndex = currentPackageIndex;
        if (direction === 'next' && currentPackageIndex < allPackagesData.length - 1) {
            newIndex++;
        } else if (direction === 'prev' && currentPackageIndex > 0) {
            newIndex--;
        }
        
        if (newIndex !== currentPackageIndex) {
            currentPackageIndex = newIndex;
            updateGallery(currentPackageIndex); 
        }
    }
    
    // --- Update Tampilan Zoom ---
    function updateZoomDisplay(userid, links) {
        const wrapper = document.getElementById("zoomedContentWrapper");
        const zoomedUserid = document.getElementById("zoomedUserid");
        const zoomLinkInput = document.getElementById("zoomLinkInput"); // Ambil elemen textarea
        
        wrapper.innerHTML = '';
        
        const validLinks = links.filter(link => link);
        validLinks.forEach(link => {
            const img = document.createElement('img');
            img.src = link;
            img.alt = 'Zoomed Image';
            wrapper.appendChild(img);
        });
        
        zoomedUserid.textContent = userid; 
        zoomLinkInput.value = validLinks.join('\n'); // Tampilkan semua link di textarea
    }
    
    // --- Update Status Tombol Navigasi Zoom ---
    function updateZoomNavButtons() {
        const prevBtn = document.getElementById('prevZoomBtn');
        const nextBtn = document.getElementById('nextZoomBtn');
        
        if (allPackagesData.length <= 1) {
            prevBtn.disabled = true;
            nextBtn.disabled = true;
        } else {
            prevBtn.disabled = (currentPackageIndex === 0);
            nextBtn.disabled = (currentPackageIndex >= allPackagesData.length - 1);
        }
    }

    // --- Fungsi Zoom Gambar ---
    function openZoom() {
        if (allPackagesData.length === 0 || allPackagesData[currentPackageIndex].links.filter(l => l.length > 0).length === 0) {
             return;
        }
        
        isZoomOpen = true;
        
        const currentPackage = allPackagesData[currentPackageIndex];
        updateZoomDisplay(currentPackage.userid, currentPackage.links);
        updateZoomNavButtons();
        
        document.getElementById("zoomModal").style.display = "flex"; 
    }
    
    // --- Fungsi Tutup Zoom ---
    function closeZoom(event) {
        const modal = document.getElementById("zoomModal");
        
        if (event.target.classList.contains('zoom-nav-button') || event.target.tagName === 'IMG' || event.target.id === 'zoomLinkInput') {
             event.stopPropagation();
             return;
        }
        
        if (event.target === modal || event.target.classList.contains('close-btn')) {
            modal.style.display = "none";
            isZoomOpen = false;
        }
    }
    
    // --- Fungsi Hapus Semua Data (TANPA NOTIFIKASI) ---
    function clearAllData() {
        // 1. Kosongkan array data utama
        allPackagesData = [];
        // 2. Kosongkan Textarea
        document.getElementById('linkInput').value = '';
        // 3. Reset status tampilan
        currentPackageIndex = 0;
        document.getElementById('maxPackageNum').textContent = 0;
        // 4. Perbarui galeri ke kondisi kosong
        updateGallery(-1); 
        
        // Hapus data scatter juga
        hapusScatter();
        
        console.log("Semua data berhasil dihapus.");
    }

    // --- Event Listener Keyboard (Untuk Navigasi Zoom) ---
    document.addEventListener('keydown', (event) => {
        if (isZoomOpen) {
            if (event.key === "ArrowLeft" || event.key === "ArrowRight") {
                 event.preventDefault(); 
            }

            if (event.key === "ArrowLeft") {
                navigatePackage('prev');
            } else if (event.key === "ArrowRight") {
                navigatePackage('next');
            } else if (event.key === "Escape") {
                closeZoom({ target: document.getElementById("zoomModal") });
            }
        }
    });

    // Inisialisasi: Muat data contoh saat halaman dimuat
    document.addEventListener('DOMContentLoaded', () => {
        // Isi Textarea dengan contoh data
        const initialText = initialData.map(p => 
            `${p.userid} ${p.links.join(' ')}`
        ).join('\n');
        
        document.getElementById('linkInput').value = initialText;
        
        loadImages(); 
    });

    /* ======================== JAVASCRIPT SCATTER (TETAP) ======================== */
    let tsModeActive = false;

    function toggleTSMode() {
      tsModeActive = !tsModeActive;
      const btn = document.getElementById("tsToggleBtn");
      if (tsModeActive) {
        btn.textContent = "TS: ON";
        btn.classList.add("on");
      } else {
        btn.textContent = "TS: OFF";
        btn.classList.remove("on");
      }
      if (document.getElementById("scatterTextarea").value.trim()) {
        hitungScatter();
      }
    }

    // Ekstrak data dari satu baris
    function extractFromLine(line) {
      let userId = "-";

      // Parsing User ID
      const parts = line.split(/\s+/);
      for (let i = 0; i < parts.length; i++) {
        if (/^20\d{2}$/.test(parts[i]) && i + 1 < parts.length) {
          const calon = parts[i + 1].trim();
          if (calon.length >= 3 && !/^\d+$/.test(calon)) {
            userId = calon;
            break;
          }
        }
      }

      // Jika mode TS aktif, tambahkan " TS" di akhir
      if (tsModeActive && userId !== "-") {
        userId += " TS";
      }

      const gambarRegex = /(https?:\/\/[^\s]+?\.(?:jpg|jpeg|png|gif|webp|bmp|svg)|https?:\/\/(?:prnt\.sc|imghostr\.com)\/[^\s]+)/gi;
      const gambarLinks = line.match(gambarRegex) || [];

      const kodeTiketMatch = line.match(/\b\d{17,20}\b/);
      const kodeTiket = kodeTiketMatch ? kodeTiketMatch[0] : "-";

      const betMatch = line.match(/BET\s+([0-9.,\- ]+)/i);
      let bettingan = "-";
      if (betMatch) {
        const parts = betMatch[1].split("-");
        bettingan = parts[0].trim();
      }

      return { userId, kodeTiket, gambarLinks, bettingan };
    }

    // Render semua hasil
    function renderHasil(transaksiList) {
      const container = document.getElementById("hasilScatterContainer");
      container.innerHTML = "";

      transaksiList.forEach((trans, idx) => {
        const { userId, kodeTiket, gambarLinks, bettingan } = trans;
        const prefix = `t${idx}_`;

        let gambarHTML = '';
        for (let i = 1; i <= 3; i++) {
          const link = gambarLinks[i - 1];
          let content = '<div>-</div>';
          if (link) {
            if (link.includes('prnt.sc') || link.includes('imghostr.com')) {
              content = `<a href="${link}" target="_blank" style="color:#ffcc00;">Lihat Gambar ${i}</a>`;
            } else {
              content = `<img src="${link}" onclick="openLightbox('${link}', '${userId}')" />`;
            }
          }
          gambarHTML += `
            <div class="gambar-slot-multi">
              <h4 style="margin:4px 0;font-size:14px;">Gambar ${i}</h4>
              ${content}
              <div class="userid-label">User ID: ${userId}</div>
            </div>
          `;
        }

        const block = document.createElement("div");
        block.className = "hasil-transaksi";
        block.innerHTML = `
          <div class="hasil-item" id="${prefix}uidItem">
            <label>User ID:</label>
            <div class="hasil-text" id="${prefix}uid">${userId}</div>
            <button class="copy-btn" onclick="copyText('${prefix}uid', '${prefix}uidItem')">💫</button>
          </div>
          <div class="hasil-item" id="${prefix}ktItem">
            <label>Kode Tiket:</label>
            <div class="hasil-text" id="${prefix}kt">${kodeTiket}</div>
            <button class="copy-btn" onclick="copyText('${prefix}kt', '${prefix}ktItem')">💫</button>
          </div>
          <div class="hasil-item" id="${prefix}lbItem">
            <label>Link Bukti:</label>
            <div class="hasil-text" id="${prefix}lb">${gambarLinks.join(", ") || "-"}</div>
            <button class="copy-btn" onclick="copyText('${prefix}lb', '${prefix}lbItem')">💫</button>
          </div>
          <div class="hasil-item" id="${prefix}betItem">
            <label>Bettingan:</label>
            <div class="hasil-text" id="${prefix}bet">${bettingan}</div>
            <button class="copy-btn" onclick="copyText('${prefix}bet', '${prefix}betItem')">💫</button>
          </div>
          <div class="gambar-container-multi">
            ${gambarHTML}
          </div>
        `;
        container.appendChild(block);
      });
    }

    // Fungsi utama
    function hitungScatter() {
      const input = document.getElementById("scatterTextarea").value.trim();
      if (!input) {
        document.getElementById("hasilScatterContainer").innerHTML = "";
        return;
      }

      const lines = input.split("\n").slice(0, 7); // Ambil maks 7 baris
      const transList = lines.map(line => extractFromLine(line.trim()));
      renderHasil(transList);
    }

    function hapusScatter() {
      document.getElementById("scatterTextarea").value = "";
      document.getElementById("hasilScatterContainer").innerHTML = "";
    }

    // Copy dengan efek background merah
    function copyText(elementId, itemContainerId) {
      const el = document.getElementById(elementId);
      const container = document.getElementById(itemContainerId);
      if (!el || el.innerText === "-") return;

      navigator.clipboard.writeText(el.innerText).then(() => {
        container.classList.add("red-bg");
        setTimeout(() => {
          container.classList.remove("red-bg");
        }, 1000);
      }).catch(err => {
        console.warn("Gagal menyalin:", err);
      });
    }

    // === LIGHTBOX DENGAN NAVIGASI ===
    let currentLightboxIndex = 0;
    let currentLightboxImages = [];
    let currentLightboxUserId = "";

    function openLightbox(imgUrl, userId) {
      const modal = document.getElementById("lightboxModal");
      const img = document.getElementById("lightboxImg");
      const caption = document.getElementById("lightboxCaption");
      currentLightboxImages = getCurrentTransaksiImages(userId);
      currentLightboxUserId = userId;
      currentLightboxIndex = currentLightboxImages.findIndex(img => img === imgUrl);
      if (currentLightboxIndex === -1) currentLightboxIndex = 0;
      img.src = currentLightboxImages[currentLightboxIndex];
      caption.innerText = `User ID: ${userId}`;
      modal.style.display = "flex";
      updateNavButtons();
    }

    function getCurrentTransaksiImages(userId) {
      const allItems = document.querySelectorAll('.hasil-transaksi');
      for (let item of allItems) {
        const uidEl = item.querySelector('.hasil-text[id$="uid"]');
        // Handle TS mode in scatter section's UID
        const currentUid = uidEl ? uidEl.innerText : '';
        const targetUid = tsModeActive && userId.endsWith(' TS') && currentUid.endsWith(' TS') 
                         ? userId 
                         : (tsModeActive && !userId.endsWith(' TS') && currentUid === userId + ' TS' ? currentUid : userId);

        if (uidEl && (currentUid === userId || currentUid === targetUid)) {
          const imgEls = item.querySelectorAll('.gambar-slot-multi img');
          return Array.from(imgEls).map(el => el.src).filter(src => src);
        }
      }
      return [];
    }


    function prevImage() {
      if (currentLightboxImages.length <= 1) return;
      currentLightboxIndex = (currentLightboxIndex - 1 + currentLightboxImages.length) % currentLightboxImages.length;
      updateLightboxImage();
    }

    function nextImage() {
      if (currentLightboxImages.length <= 1) return;
      currentLightboxIndex = (currentLightboxIndex + 1) % currentLightboxImages.length;
      updateLightboxImage();
    }

    function updateLightboxImage() {
      const img = document.getElementById("lightboxImg");
      const caption = document.getElementById("lightboxCaption");
      img.src = currentLightboxImages[currentLightboxIndex];
      caption.innerText = `User ID: ${currentLightboxUserId}`;
      updateNavButtons();
    }

    function updateNavButtons() {
      const prevBtn = document.querySelector('#lightboxModal .prev');
      const nextBtn = document.querySelector('#lightboxModal .next');

      if (currentLightboxImages.length <= 1) {
        prevBtn.style.opacity = '0.3';
        nextBtn.style.opacity = '0.3';
        prevBtn.style.pointerEvents = 'none';
        nextBtn.style.pointerEvents = 'none';
      } else {
        prevBtn.style.opacity = '1';
        nextBtn.style.opacity = '1';
        prevBtn.style.pointerEvents = 'auto';
        nextBtn.style.pointerEvents = 'auto';
      }
    }

    function closeLightbox() {
      document.getElementById("lightboxModal").style.display = "none";
      currentLightboxImages = [];
      currentLightboxUserId = "";
      currentLightboxIndex = 0;
    }

    document.addEventListener('keydown', (e) => {
      const lightbox = document.getElementById('lightboxModal');
      if (lightbox.style.display !== 'flex') return;

      if (e.key === 'ArrowLeft') {
        prevImage();
      } else if (e.key === 'ArrowRight') {
        nextImage();
      } else if (e.key === 'Escape') {
        closeLightbox();
      }
    });

    // Event listener input
    document.addEventListener("DOMContentLoaded", () => {
      const ta = document.getElementById("scatterTextarea");
      if (ta) {
        ta.addEventListener("paste", () => setTimeout(hitungScatter, 50));
        ta.addEventListener("input", hitungScatter);
      }
    });
</script>
</body>
</html>
