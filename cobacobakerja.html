<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>üé∞ Aplikasi Catatan Togel - Read Only</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    /* === CYBERPUNK/NEON THEME === */
    :root {
      --bg-dark: #0a0a1a;
      --bg-panel: rgba(20, 20, 40, 0.9);
      --neon-cyan: #00ffff;
      --neon-blue: #00ccff;
      --neon-purple: #9d00ff;
      --neon-pink: #ff00aa;
      --neon-green: #00ff88;
      --neon-red: #ff3366;
      --neon-yellow: #ffcc00;
      --text-main: #e0f0ff;
      --text-dim: #88aacc;
      --border-glow: 0 0 10px rgba(0, 255, 255, 0.5);
      --card-shadow: 0 0 20px rgba(0, 200, 255, 0.3);
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: var(--bg-dark);
      color: var(--text-main);
      min-height: 100vh;
      background-image:
        radial-gradient(circle at 20% 80%, rgba(157, 0, 255, 0.15) 0%, transparent 50%),
        radial-gradient(circle at 80% 20%, rgba(0, 255, 255, 0.1) 0%, transparent 50%),
        linear-gradient(135deg, #0a0a1a 0%, #1a1a3a 100%);
      background-attachment: fixed;
    }

    /* === HEADER === */
    .app-header {
      background: linear-gradient(90deg, rgba(0,20,40,0.95), rgba(20,20,50,0.95));
      padding: 15px 20px;
      border-bottom: 2px solid var(--neon-cyan);
      box-shadow: var(--border-glow);
      position: sticky;
      top: 0;
      z-index: 100;
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 10px;
    }

    .app-title {
      font-size: 1.4rem;
      font-weight: bold;
      color: var(--neon-cyan);
      text-shadow: 0 0 10px var(--neon-cyan);
      display: flex;
      align-items: center;
      gap: 10px;
    }

    #clock {
      font-family: 'Courier New', monospace;
      font-size: 0.95rem;
      color: var(--neon-green);
      text-shadow: 0 0 8px var(--neon-green);
      text-align: right;
    }

    /* === TAB NAVIGATION === */
    .tab-nav {
      display: flex;
      gap: 5px;
      padding: 10px 20px;
      background: rgba(15, 15, 35, 0.9);
      border-bottom: 1px solid var(--neon-purple);
      overflow-x: auto;
      flex-wrap: wrap;
    }

    .tab-btn {
      padding: 8px 16px;
      background: transparent;
      border: 1px solid var(--neon-cyan);
      color: var(--neon-cyan);
      border-radius: 20px;
      cursor: pointer;
      font-size: 0.9rem;
      transition: all 0.3s;
      white-space: nowrap;
    }

    .tab-btn:hover, .tab-btn.active {
      background: var(--neon-cyan);
      color: #000;
      box-shadow: 0 0 15px var(--neon-cyan);
    }

    /* === CONTENT AREA === */
    .tab-content {
      display: none;
      padding: 20px;
      max-width: 1400px;
      margin: 0 auto;
    }

    .tab-content.active { display: block; }

    /* === CARDS & PANELS === */
    .card {
      background: var(--bg-panel);
      border: 1px solid var(--neon-cyan);
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 16px;
      box-shadow: var(--card-shadow);
      transition: transform 0.2s;
    }

    .card:hover {
      transform: translateY(-2px);
      border-color: var(--neon-blue);
    }

    .card-title {
      color: var(--neon-cyan);
      font-size: 1.1rem;
      margin-bottom: 12px;
      padding-bottom: 8px;
      border-bottom: 1px dashed var(--neon-purple);
      display: flex;
      align-items: center;
      gap: 8px;
    }

    /* === NOTES LIST === */
    .notes-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      gap: 12px;
    }

    .note-card {
      background: rgba(30, 30, 60, 0.8);
      border: 1px solid var(--neon-purple);
      border-radius: 10px;
      padding: 12px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .note-card:hover {
      border-color: var(--neon-cyan);
      box-shadow: 0 0 12px rgba(0, 255, 255, 0.4);
    }

    .note-title {
      color: var(--neon-green);
      font-weight: bold;
      margin-bottom: 6px;
      font-size: 1rem;
    }

    .note-preview {
      color: var(--text-dim);
      font-size: 0.9rem;
      line-height: 1.4;
      display: -webkit-box;
      -webkit-line-clamp: 3;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }

    .note-date {
      font-size: 0.75rem;
      color: var(--neon-pink);
      margin-top: 8px;
      font-family: monospace;
    }

    /* === FOTO GALLERY === */
    .foto-gallery {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
      gap: 10px;
    }

    .foto-card {
      position: relative;
      border-radius: 8px;
      overflow: hidden;
      border: 2px solid var(--neon-cyan);
      cursor: pointer;
      transition: transform 0.2s;
    }

    .foto-card:hover {
      transform: scale(1.03);
      box-shadow: 0 0 15px var(--neon-cyan);
    }

    .foto-card img {
      width: 100%;
      height: 120px;
      object-fit: cover;
      display: block;
    }

    .foto-title {
      padding: 6px;
      background: rgba(0,0,0,0.7);
      font-size: 0.8rem;
      text-align: center;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    /* === TABLES === */
    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.9rem;
    }

    th {
      background: rgba(0, 100, 150, 0.3);
      color: var(--neon-cyan);
      padding: 10px;
      text-align: left;
      border: 1px solid var(--neon-purple);
    }

    td {
      padding: 10px;
      border: 1px solid rgba(0, 255, 255, 0.2);
      color: var(--text-main);
    }

    tr:hover {
      background: rgba(0, 255, 255, 0.05);
    }

    /* === SEARCH & INPUTS === */
    .search-bar {
      display: flex;
      gap: 10px;
      margin-bottom: 16px;
      flex-wrap: wrap;
    }

    .search-bar input, .search-bar select {
      flex: 1;
      min-width: 200px;
      padding: 10px 14px;
      background: rgba(10, 20, 40, 0.9);
      border: 1px solid var(--neon-cyan);
      border-radius: 8px;
      color: var(--text-main);
      font-size: 1rem;
    }

    .search-bar input:focus, .search-bar select:focus {
      outline: none;
      border-color: var(--neon-green);
      box-shadow: 0 0 10px var(--neon-green);
    }

    /* === BUTTONS === */
    .btn {
      padding: 8px 16px;
      background: linear-gradient(135deg, var(--neon-purple), var(--neon-pink));
      border: none;
      border-radius: 8px;
      color: white;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.2s;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 0 15px var(--neon-purple);
    }

    .btn-copy {
      background: var(--neon-cyan);
      color: #000;
      padding: 4px 10px;
      font-size: 0.8rem;
      border-radius: 6px;
    }

    .btn-copy:hover {
      box-shadow: 0 0 10px var(--neon-cyan);
    }

    /* === LIGHTBOX/ZOOM === */
    #lightbox {
      display: none;
      position: fixed;
      top: 0; left: 0;
      width: 100vw; height: 100vh;
      background: rgba(0,0,0,0.95);
      z-index: 1000;
      justify-content: center;
      align-items: center;
      flex-direction: column;
      padding: 20px;
    }

    #lightboxImg {
      max-width: 95vw;
      max-height: 85vh;
      border-radius: 12px;
      border: 3px solid var(--neon-cyan);
      box-shadow: 0 0 30px var(--neon-cyan);
      cursor: zoom-in;
      transition: transform 0.2s;
    }

    .lightbox-controls {
      margin-top: 15px;
      display: flex;
      gap: 10px;
      align-items: center;
      flex-wrap: wrap;
    }

    /* === TOAST NOTIFICATION === */
    .toast {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background: linear-gradient(135deg, var(--neon-green), #00cc88);
      color: #000;
      padding: 12px 20px;
      border-radius: 10px;
      font-weight: bold;
      box-shadow: 0 0 20px var(--neon-green);
      z-index: 9999;
      animation: slideIn 0.3s, fadeOut 0.3s 2.7s forwards;
    }

    @keyframes slideIn {
      from { transform: translateX(100%); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }

    @keyframes fadeOut {
      from { opacity: 1; }
      to { opacity: 0; }
    }

    /* === LOADING SPINNER === */
    .loading {
      text-align: center;
      padding: 40px;
      color: var(--neon-cyan);
    }

    .spinner {
      width: 40px; height: 40px;
      border: 3px solid var(--neon-cyan);
      border-top-color: transparent;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto 15px;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* === DEPO/WD ANALYSIS === */
    .depo-wd-container {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
      gap: 16px;
    }

    .user-card {
      background: var(--bg-panel);
      border: 1px solid var(--neon-cyan);
      border-radius: 12px;
      overflow: hidden;
    }

    .user-header {
      background: linear-gradient(135deg, var(--neon-purple), var(--neon-pink));
      padding: 12px;
      font-weight: bold;
      color: #fff;
    }

    .user-body {
      padding: 12px;
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }

    .col-title {
      font-size: 0.85rem;
      color: var(--neon-cyan);
      margin-bottom: 8px;
    }

    .entry-list {
      list-style: none;
      max-height: 150px;
      overflow-y: auto;
      font-size: 0.85rem;
    }

    .entry-item {
      padding: 4px 0;
      border-bottom: 1px solid rgba(0,255,255,0.1);
    }

    .total-row {
      margin-top: 8px;
      padding-top: 8px;
      border-top: 1px solid var(--neon-purple);
      font-weight: bold;
    }

    .card-footer {
      padding: 12px;
      background: rgba(0,0,0,0.3);
      border-top: 1px solid var(--neon-purple);
    }

    .status-badge {
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 0.85rem;
      font-weight: bold;
      display: inline-block;
    }

    /* === CHAT BOX (Tanya Z) === */
    .chat-container {
      display: flex;
      flex-direction: column;
      height: 500px;
      background: var(--bg-panel);
      border: 1px solid var(--neon-cyan);
      border-radius: 12px;
      overflow: hidden;
    }

    .chat-history {
      flex: 1;
      overflow-y: auto;
      padding: 16px;
    }

    .message {
      display: flex;
      margin: 10px 0;
    }

    .user-message { justify-content: flex-end; }
    .ai-message { justify-content: flex-start; }

    .message-bubble {
      padding: 12px 16px;
      border-radius: 16px;
      max-width: 80%;
      word-wrap: break-word;
      font-size: 0.95rem;
      line-height: 1.4;
    }

    .user-message .message-bubble {
      background: rgba(60,180,255,0.15);
      border: 1px solid var(--neon-cyan);
      color: var(--text-main);
    }

    .ai-message .message-bubble {
      background: rgba(40,40,60,0.8);
      border: 1px solid var(--neon-purple);
      color: var(--text-main);
    }

    .chat-input-area {
      display: flex;
      gap: 10px;
      padding: 12px;
      background: rgba(0,0,0,0.3);
      border-top: 1px solid var(--neon-purple);
    }

    .chat-input-area input {
      flex: 1;
      padding: 10px 14px;
      background: rgba(10,20,40,0.9);
      border: 1px solid var(--neon-cyan);
      border-radius: 8px;
      color: var(--text-main);
    }

    /* === ACCORDION === */
    details {
      margin-bottom: 12px;
      background: rgba(20,20,40,0.6);
      border-radius: 8px;
      overflow: hidden;
    }

    summary {
      padding: 12px;
      cursor: pointer;
      color: var(--neon-cyan);
      font-weight: bold;
      background: rgba(0,0,0,0.2);
      list-style: none;
    }

    summary::-webkit-details-marker { display: none; }

    summary:hover {
      background: rgba(0,255,255,0.1);
    }

    details[open] summary {
      border-bottom: 1px solid var(--neon-purple);
    }

    .accordion-content {
      padding: 12px;
    }

    /* === RESPONSIVE === */
    @media (max-width: 768px) {
      .app-title { font-size: 1.1rem; }
      #clock { font-size: 0.85rem; }
      .tab-btn { padding: 6px 12px; font-size: 0.85rem; }
      .card { padding: 12px; }
      .user-body { grid-template-columns: 1fr; }
      .chat-container { height: 400px; }
    }

    /* === SPECIAL EFFECTS === */
    @keyframes pulseWhite {
      from { text-shadow: 0 0 6px #ffffff; }
      to { text-shadow: 0 0 12px #ffffff, 0 0 24px #eeeeee; }
    }

    @keyframes pulsePlasma {
      from { text-shadow: 0 0 8px #39FF14, 0 0 16px #00ff00; }
      to { text-shadow: 0 0 14px #39FF14, 0 0 28px #00ff00, 0 0 40px #39FF14; }
    }

    @keyframes pulseRuby {
      from { text-shadow: 0 0 6px #FF073A; }
      to { text-shadow: 0 0 12px #FF073A, 0 0 24px #FF0055; }
    }

    @keyframes pulsePurple {
      from { text-shadow: 0 0 6px #9D00FF; }
      to { text-shadow: 0 0 12px #9D00FF, 0 0 24px #7A00FF; }
    }
  </style>
</head>
<body>

  <!-- === HEADER === -->
  <header class="app-header">
    <div class="app-title">
      <i class="fas fa-dice"></i>
      <span>üé∞ CATATAN TOGEL</span>
      <span style="font-size:0.8em; color:var(--neon-pink);">(Read Only)</span>
    </div>
    <div id="clock">‚è≥ Loading...</div>
  </header>

  <!-- === TAB NAVIGATION === -->
  <nav class="tab-nav">
    <button class="tab-btn active" data-tab="catatan">üìù Catatan</button>
    <button class="tab-btn" data-tab="foto">üì∑ Foto</button>
    <button class="tab-btn" data-tab="pasaran">üé∞ Pasaran</button>
    <button class="tab-btn" data-tab="hitungan">üî¢ Hitungan</button>
    <button class="tab-btn" data-tab="pengaturan">‚öôÔ∏è Pengaturan</button>
    <button class="tab-btn" data-tab="kendala">üö® Kendala</button>
    <button class="tab-btn" data-tab="report">üìã Report</button>
    <button class="tab-btn" data-tab="depo">üí∞ Depo/WD</button>
    <button class="tab-btn" data-tab="chat">ü§ñ Tanya Z</button>
  </nav>

  <!-- === TAB: CATATAN === -->
  <section id="catatan" class="tab-content active">
    <div class="card">
      <div class="card-title"><i class="fas fa-folder"></i> Pilih Folder</div>
      <div class="search-bar">
        <select id="folderSelect">
          <option value="DEPOSIT">üí∞ DEPOSIT</option>
          <option value="WITHDRAW">üí∏ WITHDRAW</option>
          <option value="KENDALA_ALL">üö® KENDALA ALL</option>
          <option value="CARA_BERMAIN">üéÆ CARA BERMAIN</option>
        </select>
        <input type="text" id="searchNotes" placeholder="üîç Cari catatan...">
      </div>
    </div>
    <div id="notesList" class="notes-grid">
      <div class="loading">
        <div class="spinner"></div>
        <p>Memuat data...</p>
      </div>
    </div>
  </section>

  <!-- === TAB: FOTO === -->
  <section id="foto" class="tab-content">
    <div class="card">
      <div class="card-title"><i class="fas fa-images"></i> Galeri Foto</div>
      <div class="search-bar">
        <input type="text" id="searchFoto" placeholder="üîç Cari foto...">
      </div>
    </div>
    <div id="fotoList" class="foto-gallery">
      <div class="loading">
        <div class="spinner"></div>
        <p>Memuat foto...</p>
      </div>
    </div>
  </section>

  <!-- === TAB: PASARAN === -->
  <section id="pasaran" class="tab-content">
    <div class="card">
      <div class="card-title"><i class="fas fa-list"></i> Daftar Pasaran Togel</div>
      <div class="search-bar">
        <input type="text" id="searchPasaran" placeholder="üîç Cari pasaran...">
        <span id="tanggalPasaran" style="color:var(--neon-green); font-weight:bold;"></span>
      </div>
      <div style="overflow-x:auto;">
        <table>
          <thead>
            <tr><th>Prediksi</th><th>Jadwal</th></tr>
          </thead>
          <tbody id="pasaranBody">
            <tr><td colspan="2" class="loading">Memuat...</td></tr>
          </tbody>
        </table>
      </div>
    </div>
  </section>

  <!-- === TAB: HITUNGAN === -->
  <section id="hitungan" class="tab-content">
    <div class="card">
      <div class="card-title"><i class="fas fa-calculator"></i> Hitungan Hadiah</div>
      <div class="search-bar">
        <select id="kelompokDropdown">
          <option value="">-- Pilih Tipe Hitungan --</option>
        </select>
        <select id="labelDropdown">
          <option value="">-- Pilih Label --</option>
        </select>
      </div>
      <div id="detailHitungan" style="min-height:60px; padding:10px; background:rgba(0,30,60,0.5); border-radius:8px;">
        <p style="color:var(--text-dim);">Pilih kelompok dan label untuk melihat hasil hitungan.</p>
      </div>
    </div>
  </section>

  <!-- === TAB: PENGATURAN === -->
  <section id="pengaturan" class="tab-content">
    <div class="card">
      <div class="card-title"><i class="fas fa-cog"></i> Pengaturan (View Only)</div>
      <div id="pengaturanContent">
        <div class="loading">
          <div class="spinner"></div>
          <p>Memuat pengaturan...</p>
        </div>
      </div>
    </div>
  </section>

  <!-- === TAB: KENDALA === -->
  <section id="kendala" class="tab-content">
    <div class="card">
      <div class="card-title"><i class="fas fa-exclamation-triangle"></i> Kendala & Solusi</div>
      <div id="kendalaList">
        <div class="loading">
          <div class="spinner"></div>
          <p>Memuat data kendala...</p>
        </div>
      </div>
    </div>
  </section>

  <!-- === TAB: REPORT === -->
  <section id="report" class="tab-content">
    <div class="card">
      <div class="card-title"><i class="fas fa-clipboard-list"></i> Report Line</div>
      <div class="search-bar">
        <input type="text" id="searchReport" placeholder="üîç Cari report...">
      </div>
      <div id="reportList">
        <div class="loading">
          <div class="spinner"></div>
          <p>Memuat report...</p>
        </div>
      </div>
    </div>
  </section>

  <!-- === TAB: DEPO/WD === -->
  <section id="depo" class="tab-content">
    <div class="card">
      <div class="card-title"><i class="fas fa-exchange-alt"></i> Analisis Deposit & Withdraw</div>
      <div class="search-bar">
        <textarea id="dataDeposit" placeholder="üì• Paste data DEPOSIT di sini..." style="width:100%; min-height:150px; background:rgba(0,30,20,0.6); border:1px solid var(--neon-green); border-radius:8px; color:var(--text-main); padding:10px; font-family:monospace;"></textarea>
        <textarea id="dataWithdraw" placeholder="üì§ Paste data WITHDRAW di sini..." style="width:100%; min-height:150px; background:rgba(30,0,20,0.6); border:1px solid var(--neon-pink); border-radius:8px; color:var(--text-main); padding:10px; font-family:monospace;"></textarea>
        <button class="btn" onclick="prosesDepositWithdraw()">üîç Analisis</button>
        <button class="btn" onclick="clearDepoWd()">üßπ Clear</button>
      </div>
      <div id="hasilDepoWd" class="depo-wd-container"></div>
    </div>
  </section>

  <!-- === TAB: TANYA Z (AI CHAT) === -->
  <section id="chat" class="tab-content">
    <div class="card">
      <div class="card-title"><i class="fas fa-robot"></i> Tanya Z - AI Assistant</div>
      <div class="chat-container">
        <div id="chatHistory" class="chat-history">
          <div class="message ai-message">
            <div class="message-bubble">
              üëã Halo! Saya Z, asisten AI untuk aplikasi ini. Ada yang bisa saya bantu?
              <br><br>
              üí° Tips: Ketik <code>/gambar: deskripsi</code> untuk membuat gambar
            </div>
          </div>
        </div>
        <div class="chat-input-area">
          <input type="text" id="chatInput" placeholder="Ketik pesan atau paste gambar..." onkeydown="if(event.key==='Enter'&&!event.shiftKey){event.preventDefault();sendMessage();}">
          <button class="btn" id="sendButton" onclick="sendMessage()">üì§ Kirim</button>
        </div>
      </div>
    </div>
  </section>

  <!-- === LIGHTBOX === -->
  <div id="lightbox">
    <img id="lightboxImg" src="" alt="Zoom">
    <div class="lightbox-controls">
      <button class="btn" onclick="closeLightbox()">‚ùå Tutup</button>
      <button class="btn btn-copy" onclick="copyLightboxImage()">üìã Copy Foto</button>
      <button class="btn" onclick="changeLightbox(-1)">‚¨ÖÔ∏è Prev</button>
      <button class="btn" onclick="changeLightbox(1)">Next ‚û°Ô∏è</button>
      <span style="color:var(--text-dim); font-size:0.9rem;">üí° Esc untuk tutup, Arrow untuk navigasi</span>
    </div>
  </div>

  <!-- === MAIN JAVASCRIPT === -->
  <script>
    // ‚ö†Ô∏è GANTI DENGAN URL WEB APP ANDA SETELAH DEPLOY
    const API_BASE_URL = 'https://script.google.com/macros/s/YOUR_WEB_APP_ID/exec';

    // === GLOBAL STATE ===
    let appData = null;
    let lightboxImages = [];
    let lightboxIndex = 0;
    let currentFolder = 'DEPOSIT';
    let conversationHistory = [];

    // === CLOCK ===
    function updateClock() {
      const el = document.getElementById('clock');
      if (!el) return;
      const now = new Date();
      const dateStr = now.toLocaleDateString('id-ID', {
        weekday: 'long', day: '2-digit', month: 'long', year: 'numeric'
      });
      const timeStr = now.toLocaleTimeString('id-ID', {
        hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: false
      });
      el.innerHTML = `<span class="date">${dateStr}</span><br><span class="time">${timeStr}</span>`;
    }
    updateClock();
    setInterval(updateClock, 1000);

    // === TOAST NOTIFICATION ===
    function showToast(msg) {
      const toast = document.createElement('div');
      toast.className = 'toast';
      toast.textContent = msg;
      document.body.appendChild(toast);
      setTimeout(() => toast.remove(), 3000);
    }

    // === COPY TO CLIPBOARD ===
    function copyToClipboard(text, label = 'Teks') {
      navigator.clipboard.writeText(text).then(() => {
        showToast(`‚úÖ ${label} disalin!`);
      }).catch(() => {
        showToast('‚ùå Gagal menyalin');
      });
    }

    // === FETCH ALL DATA (SINGLE API CALL) ===
    async function loadAllData() {
      try {
        const res = await fetch(API_BASE_URL, { method: 'GET', redirect: 'follow' });
        const result = await res.json();
        if (result.status !== 'success') throw new Error(result.message);
        appData = result.data;
        renderAllTabs();
      } catch (err) {
        console.error('Load error:', err);
        showToast('‚ùå Gagal memuat data: ' + err.message);
        document.querySelectorAll('.loading').forEach(el => {
          el.innerHTML = `<p style="color:var(--neon-red)">‚ùå ${err.message}</p>`;
        });
      }
    }

    // === RENDER ALL TABS ===
    function renderAllTabs() {
      if (!appData) return;

      // Notes
      renderNotesList(appData.notes?.['DEPOSIT'] || [], 'DEPOSIT');

      // Foto
      renderFotoGallery(appData.notes?.['FOTO'] || []);

      // Pasaran
      if (appData.pasaran) {
        document.getElementById('tanggalPasaran').textContent = `üìÖ ${appData.pasaran.tanggal || ''}`;
        renderPasaranTable(appData.pasaran.list || []);
      }

      // Hitungan
      if (appData.hitungan?.kelompok) {
        const dropdown = document.getElementById('kelompokDropdown');
        dropdown.innerHTML = '<option value="">-- Pilih Tipe Hitungan --</option>';
        Object.keys(appData.hitungan.kelompok).forEach(k => {
          dropdown.add(new Option(k, k));
        });
      }

      // Pengaturan
      renderPengaturan(appData.pengaturan);

      // Kendala
      renderKendala(appData.kendala || []);

      // Report
      renderReport(appData.report || []);

      // Depo/WD
      document.getElementById('dataDeposit').value = appData.depoWd?.deposit || '';
      document.getElementById('dataWithdraw').value = appData.depoWd?.withdraw || '';
    }

    // === RENDER NOTES ===
    function renderNotesList(notes, folder) {
      const container = document.getElementById('notesList');
      if (!container) return;
      if (!notes.length) {
        container.innerHTML = '<p style="text-align:center; color:var(--text-dim);">Tidak ada catatan.</p>';
        return;
      }
      container.innerHTML = notes.map(note => `
        <div class="note-card" onclick="showNoteDetail('${note.id}')">
          <div class="note-title">${note.title || 'Tanpa judul'}</div>
          <div class="note-preview">${(note.content || '').substring(0, 100)}${note.content?.length > 100 ? '...' : ''}</div>
          <div class="note-date">üïê ${note.date}</div>
        </div>
      `).join('');
    }

    // === RENDER FOTO GALLERY ===
    function renderFotoGallery(fotos) {
      const container = document.getElementById('fotoList');
      if (!container) return;
      lightboxImages = [];
      if (!fotos.length) {
        container.innerHTML = '<p style="text-align:center; color:var(--text-dim);">Tidak ada foto.</p>';
        return;
      }
      container.innerHTML = fotos.map((foto, i) => {
        lightboxImages.push(foto.content);
        return `
          <div class="foto-card" onclick="openLightbox('${foto.content}', ${i})">
            <img src="${foto.content}" alt="${foto.title}" onerror="this.parentElement.style.display='none'">
            <div class="foto-title">${foto.title || 'Tanpa judul'}</div>
          </div>
        `;
      }).join('');
    }

    // === RENDER PASARAN TABLE ===
    function renderPasaranTable(list) {
      const tbody = document.getElementById('pasaranBody');
      if (!tbody) return;
      if (!list.length) {
        tbody.innerHTML = '<tr><td colspan="2">Tidak ada data</td></tr>';
        return;
      }
      tbody.innerHTML = list.map(row => `
        <tr>
          <td onclick="copyToClipboard('${row[0]}', 'Prediksi')" style="cursor:pointer">üìã ${row[0]}</td>
          <td onclick="copyToClipboard('${row[1]}', 'Jadwal')" style="cursor:pointer">üïê ${row[1]}</td>
        </tr>
      `).join('');
    }

    // === RENDER PENGATURAN ===
    function renderPengaturan(data) {
      const container = document.getElementById('pengaturanContent');
      if (!container || !data?.data) return;
      container.innerHTML = data.data.map(group => `
        <details>
          <summary>üìä ${group.judul}</summary>
          <div class="accordion-content">
            <table>
              <thead><tr><th>Nama</th><th>Hadiah</th><th>Diskon</th></tr></thead>
              <tbody>
                ${group.items.map(it => `
                  <tr>
                    <td>${it.nama||'‚Äî'}</td>
                    <td style="color:var(--neon-green)">${it.hadiah||'‚Äî'}</td>
                    <td>${(it.diskon && String(it.diskon).includes('%')) ? it.diskon : 'NO DISCOUNT'}</td>
                  </tr>
                `).join('')}
              </tbody>
            </table>
          </div>
        </details>
      `).join('');
    }

    // === RENDER KENDALA ===
    function renderKendala(items) {
      const container = document.getElementById('kendalaList');
      if (!container) return;
      if (!items.length) {
        container.innerHTML = '<p>Tidak ada data kendala.</p>';
        return;
      }
      container.innerHTML = items.map(item => `
        <div class="card" style="margin-bottom:10px;">
          <div style="color:var(--neon-cyan); font-weight:bold; margin-bottom:8px;">${item.judul || 'Tanpa judul'}</div>
          ${[item.jawaban1, item.jawaban2, item.jawaban3].filter(a => a).map(ans =>
            `<div style="margin:6px 0; padding-left:12px; border-left:2px solid var(--neon-purple);">${ans}</div>`
          ).join('')}
        </div>
      `).join('');
    }

    // === RENDER REPORT ===
    function renderReport(items) {
      const container = document.getElementById('reportList');
      if (!container) return;
      if (!items.length) {
        container.innerHTML = '<p>Tidak ada report.</p>';
        return;
      }
      container.innerHTML = items.map(item => `
        <div class="card" style="margin-bottom:10px;">
          <div style="color:var(--neon-green); font-weight:bold;">${item.colA || '‚Äî'}</div>
          ${item.colB ? `<div style="margin:6px 0; background:rgba(0,40,60,0.4); padding:8px; border-radius:6px;">üìù ${item.colB}</div>` : ''}
          ${item.colC ? `<div style="margin:4px 0; font-size:0.9rem; color:var(--text-dim);">üì§ ${item.colC}</div>` : ''}
          ${item.colD ? `<div style="margin:4px 0; font-size:0.9rem; color:var(--neon-pink);">üì± ${item.colD}</div>` : ''}
        </div>
      `).join('');
    }

    // === LIGHTBOX FUNCTIONS ===
    function openLightbox(src, index) {
      document.getElementById('lightboxImg').src = src;
      document.getElementById('lightbox').style.display = 'flex';
      lightboxIndex = index || 0;
    }

    function closeLightbox() {
      document.getElementById('lightbox').style.display = 'none';
      document.getElementById('lightboxImg').src = '';
    }

    function changeLightbox(direction) {
      lightboxIndex += direction;
      if (lightboxIndex < 0) lightboxIndex = lightboxImages.length - 1;
      if (lightboxIndex >= lightboxImages.length) lightboxIndex = 0;
      document.getElementById('lightboxImg').src = lightboxImages[lightboxIndex];
    }

    async function copyLightboxImage() {
      const img = document.getElementById('lightboxImg');
      if (!img.src) return showToast('‚ùå Tidak ada gambar');
      try {
        const res = await fetch(img.src);
        const blob = await res.blob();
        await navigator.clipboard.write([new ClipboardItem({ [blob.type]: blob })]);
        showToast('‚úÖ Foto disalin!');
      } catch {
        showToast('‚ùå Gagal menyalin (CORS)');
      }
    }

    document.getElementById('lightbox')?.addEventListener('click', (e) => {
      if (e.target.id === 'lightbox') closeLightbox();
    });

    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') closeLightbox();
      if (e.key === 'ArrowLeft') changeLightbox(-1);
      if (e.key === 'ArrowRight') changeLightbox(1);
    });

    // === TAB SWITCHING ===
    document.querySelectorAll('.tab-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        btn.classList.add('active');
        document.getElementById(btn.dataset.tab).classList.add('active');
      });
    });

    // === FOLDER SELECT ===
    document.getElementById('folderSelect')?.addEventListener('change', function() {
      if (appData?.notes) renderNotesList(appData.notes[this.value] || [], this.value);
    });

    // === SEARCH FUNCTIONS ===
    document.getElementById('searchNotes')?.addEventListener('input', function() {
      const q = this.value.toLowerCase();
      document.querySelectorAll('.note-card').forEach(card => {
        card.style.display = card.textContent.toLowerCase().includes(q) ? 'block' : 'none';
      });
    });

    document.getElementById('searchFoto')?.addEventListener('input', function() {
      const q = this.value.toLowerCase();
      document.querySelectorAll('.foto-card').forEach(card => {
        card.style.display = card.textContent.toLowerCase().includes(q) ? 'block' : 'none';
      });
    });

    document.getElementById('searchPasaran')?.addEventListener('input', function() {
      const q = this.value.toLowerCase();
      document.querySelectorAll('#pasaranBody tr').forEach(row => {
        row.style.display = row.textContent.toLowerCase().includes(q) ? '' : 'none';
      });
    });

    // === HITUNGAN DROPDOWNS ===
    document.getElementById('kelompokDropdown')?.addEventListener('change', function() {
      const labelDropdown = document.getElementById('labelDropdown');
      labelDropdown.innerHTML = '<option value="">-- Pilih Label --</option>';
      if (appData?.hitungan?.kelompok?.[this.value]) {
        appData.hitungan.kelompok[this.value].forEach(item => {
          labelDropdown.add(new Option(item.label, item.label));
        });
      }
    });

    document.getElementById('labelDropdown')?.addEventListener('change', function() {
      const kelompok = document.getElementById('kelompokDropdown').value;
      const label = this.value;
      const detail = document.getElementById('detailHitungan');
      if (appData?.hitungan?.kelompok?.[kelompok]) {
        const item = appData.hitungan.kelompok[kelompok].find(i => i.label === label);
        if (item) {
          detail.innerHTML = `<div style="font-size:1.3rem; color:var(--neon-green); font-weight:bold; cursor:pointer" onclick="copyToClipboard('${item.value}', 'Hasil')">${item.value}</div>`;
        }
      }
    });

    // === DEPO/WD ANALYSIS ===
    function clearDepoWd() {
      document.getElementById('dataDeposit').value = '';
      document.getElementById('dataWithdraw').value = '';
      document.getElementById('hasilDepoWd').innerHTML = '';
    }

    function prosesDepositWithdraw() {
      const rawDeposit = document.getElementById('dataDeposit').value;
      const rawWithdraw = document.getElementById('dataWithdraw').value;

      if (!rawDeposit.trim() || !rawWithdraw.trim()) {
        document.getElementById('hasilDepoWd').innerHTML = '<p style="color:var(--neon-red); text-align:center;">‚ö†Ô∏è Harap isi kedua kolom!</p>';
        return;
      }

      const depositList = rawDeposit.split('\n').map(line => parseLine(line, false)).filter(Boolean);
      const withdrawList = rawWithdraw.split('\n').map(line => parseLine(line, true)).filter(Boolean);

      if (depositList.length === 0 || withdrawList.length === 0) {
        document.getElementById('hasilDepoWd').innerHTML = '<p style="color:var(--neon-red); text-align:center;">‚ùå Format data tidak valid!</p>';
        return;
      }

      const depositTotal = {};
      const withdrawTotal = {};
      const depositDetails = {};
      const withdrawDetails = {};

      depositList.forEach(item => {
        const key = item.nama.toLowerCase().trim();
        depositTotal[key] = (depositTotal[key] || 0) + item.nominalClean;
        if (!depositDetails[key]) depositDetails[key] = [];
        depositDetails[key].push({ raw: item.nominalRaw, clean: item.nominalClean });
      });

      withdrawList.forEach(item => {
        const key = item.nama.toLowerCase().trim();
        withdrawTotal[key] = (withdrawTotal[key] || 0) + item.nominalClean;
        if (!withdrawDetails[key]) withdrawDetails[key] = [];
        withdrawDetails[key].push({ raw: item.nominalRaw, clean: item.nominalClean });
      });

      const allNames = new Set([...Object.keys(depositTotal), ...Object.keys(withdrawTotal)]);
      const results = [];

      allNames.forEach(key => {
        const namaAsli = depositDetails[key] ? key : withdrawDetails[key] ? key : key;
        const depo = depositTotal[key] || 0;
        const wd = withdrawTotal[key] || 0;
        const diff = depo - wd;

        let status, bgColor;
        if (depo > 0 && wd > 0) {
          if (diff === 0) { status = '‚úÖ COCOK'; bgColor = '#2e7d32'; }
          else { status = '‚ö†Ô∏è BEDA TOTAL'; bgColor = '#ff8f00'; }
        } else {
          status = '‚ùå TIDAK LENGKAP'; bgColor = '#b71c1c';
        }

        results.push({
          nama: namaAsli,
          depoFmt: depo > 0 ? formatRupiah(depo) : '‚Äì',
          wdFmt: wd > 0 ? formatRupiah(wd) : '‚Äì',
          selisih: diff === 0 ? '0' : (diff > 0 ? `+${formatRupiah(diff)}` : formatRupiah(diff)),
          status, bgColor,
          depositEntries: depositDetails[key] || [],
          withdrawEntries: withdrawDetails[key] || []
        });
      });

      renderDepoWdResults(results);
    }

    function parseLine(line, isWithdraw) {
      line = line.trim();
      if (!line) return null;
      const parts = line.split('\t').map(p => p.trim()).filter(p => p);
      if (parts.length >= 2) {
        const nominalClean = parseInt(String(parts[1]).replace(/[^0-9]/g, '')) || 0;
        return {
          nama: extractName(parts[0]),
          nominalRaw: parts[1],
          nominalClean,
          asli: line
        };
      }
      return null;
    }

    function extractName(text) {
      let cleaned = text.trim();
      const depoIndex = cleaned.indexOf('DEPO ');
      if (depoIndex !== -1) cleaned = cleaned.substring(depoIndex + 5).trim();
      const lastSlash = cleaned.lastIndexOf('/');
      if (lastSlash !== -1) return cleaned.substring(lastSlash + 1).trim();
      return cleaned;
    }

    function formatRupiah(n) {
      return new Intl.NumberFormat('id-ID').format(n);
    }

    function renderDepoWdResults(results) {
      const container = document.getElementById('hasilDepoWd');
      container.innerHTML = results.map(row => `
        <div class="user-card">
          <div class="user-header" style="background: ${row.bgColor};">${row.nama}</div>
          <div class="user-body">
            <div class="col">
              <div class="col-title">üì• DEPOSIT</div>
              <ul class="entry-list">
                ${row.depositEntries.length > 0 ? row.depositEntries.map(e => `<li class="entry-item">${e.raw}</li>`).join('') : '<li class="entry-item">(Kosong)</li>'}
              </ul>
              <div class="total-row">Total: <span style="color:var(--neon-blue);">${row.depoFmt}</span></div>
            </div>
            <div class="col">
              <div class="col-title">üì§ WITHDRAW</div>
              <ul class="entry-list">
                ${row.withdrawEntries.length > 0 ? row.withdrawEntries.map(e => `<li class="entry-item">${e.raw}</li>`).join('') : '<li class="entry-item">(Kosong)</li>'}
              </ul>
              <div class="total-row">Total: <span style="color:var(--neon-pink);">${row.wdFmt}</span></div>
            </div>
          </div>
          <div class="card-footer">
            <div class="status-badge" style="background: ${row.bgColor};">${row.status}</div>
            <div style="margin-top:8px; font-size:0.9rem;">Selisih: <span style="color:var(--neon-cyan); font-weight:bold;">${row.selisih}</span></div>
          </div>
        </div>
      `).join('');
    }

    // === AI CHAT (TANYA Z) ===
    let conversationHistoryChat = [];

    async function sendMessage() {
      const input = document.getElementById('chatInput');
      const userText = input.value.trim();
      if (!userText) return;

      displayMessage('user', userText);
      input.value = '';

      // Command khusus
      if (userText.toLowerCase().startsWith('/gambar:')) {
        const prompt = userText.substring(8).trim();
        if (!prompt) {
          displayMessage('ai', '‚ùå Prompt tidak boleh kosong');
          return;
        }
        displayMessage('ai', '‚è≥ Membuat gambar...');
        // Note: Ini perlu backend support untuk generateImageWithGemini
        return;
      }

      // Kirim ke API AI
      conversationHistoryChat.push({ role: 'user', parts: [{ text: userText }] });

      try {
        const res = await fetch(API_BASE_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ action: 'callGemini', history: conversationHistoryChat })
        });
        const result = await res.json();

        if (result.status === 'success' && result.response) {
          conversationHistoryChat.push({ role: 'model', parts: [{ text: result.response }] });
          displayMessage('ai', result.response);
        } else {
          displayMessage('ai', '‚ùå Gagal mendapatkan respons AI');
        }
      } catch (err) {
        displayMessage('ai', '‚ùå Error: ' + err.message);
      }
    }

    function displayMessage(sender, text) {
      const chatHistory = document.getElementById('chatHistory');
      const messageDiv = document.createElement('div');
      messageDiv.className = `message ${sender}-message`;

      const bubble = document.createElement('div');
      bubble.className = 'message-bubble';
      bubble.innerHTML = text.replace(/\n/g, '<br>');

      messageDiv.appendChild(bubble);
      chatHistory.appendChild(messageDiv);
      chatHistory.scrollTop = chatHistory.scrollHeight;
    }

    // === INITIALIZATION ===
    document.addEventListener('DOMContentLoaded', () => {
      loadAllData();
    });
  </script>
</body>
</html>
